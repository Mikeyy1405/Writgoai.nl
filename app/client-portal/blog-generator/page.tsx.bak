
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  FileText, 
  Loader2, 
  Sparkles,
  Settings2,
  Target,
  PenTool,
  BarChart3,
  ArrowLeft
} from 'lucide-react';
import { toast } from 'sonner';
import BlogCanvas from '@/components/blog-canvas';
import Link from 'next/link';

// WritgoAI Brand Colors
const BRAND_COLORS = {
  navy: '#000814',
  orange: '#FFA500',
  white: '#FFFFFF',
  cardBg: '#003459',
  cardBorder: '#004d73',
};

export default function BlogGenerator() {
  const { data: session } = useSession() || {};
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState(0);
  
  // Form state
  const [topic, setTopic] = useState('');
  const [keywords, setKeywords] = useState('');
  const [wordCount, setWordCount] = useState('1500');
  const [tone, setTone] = useState('professional');
  const [language, setLanguage] = useState('nl');
  const [seoOptimized, setSeoOptimized] = useState(true);
  const [includeImage, setIncludeImage] = useState(true);
  const [imageStyle, setImageStyle] = useState('realistic');
  const [projectId, setProjectId] = useState<string>('');
  const [sitemapUrl, setSitemapUrl] = useState('');
  
  // Projects
  const [projects, setProjects] = useState<any[]>([]);
  const [loadingProjects, setLoadingProjects] = useState(true);
  
  // Generated content
  const [generatedArticle, setGeneratedArticle] = useState('');
  const [articleTitle, setArticleTitle] = useState('');
  
  // Status updates
  const [statusMessage, setStatusMessage] = useState('');

  // Check authentication
  useEffect(() => {
    if (!session) {
      router.push('/client-login');
    } else {
      loadProjects();
    }
  }, [session, router]);

  // Auto-fill sitemap URL when project is selected
  useEffect(() => {
    if (projectId && projectId !== 'none') {
      const selectedProject = projects.find(p => p.id === projectId);
      if (selectedProject?.websiteUrl) {
        console.log('üîó Auto-filling sitemap URL from project:', selectedProject.websiteUrl);
        setSitemapUrl(selectedProject.websiteUrl);
      }
    } else {
      // Clear sitemap URL when no project is selected
      setSitemapUrl('');
    }
  }, [projectId, projects]);

  // Load projects
  const loadProjects = async () => {
    try {
      const response = await fetch('/api/client/ai-settings');
      if (response.ok) {
        const data = await response.json();
        setProjects([
          { id: '', name: 'Geen project' },
          ...data.projects
        ]);
      }
    } catch (error) {
      console.error('Error loading projects:', error);
    } finally {
      setLoadingProjects(false);
    }
  };

  // Generate blog
  const generateBlog = async () => {
    if (!topic.trim()) {
      toast.error('Voer een onderwerp in');
      return;
    }

    setLoading(true);
    setProgress(0);
    setStatusMessage('üöÄ Blog generatie starten...');

    try {
      const response = await fetch('/api/ai-agent/generate-blog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          topic,
          keywords: keywords.split(',').map(k => k.trim()).filter(Boolean),
          wordCount: parseInt(wordCount),
          tone,
          language,
          seoOptimized,
          includeImage,
          imageStyle,
          projectId: projectId || undefined,
          sitemapUrl: sitemapUrl || undefined,
        }),
      });

      if (!response.ok) {
        throw new Error('Fout bij het genereren van blog');
      }

      // Read streaming response
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      if (!reader) {
        throw new Error('Geen response stream');
      }

      while (true) {
        const { done, value } = await reader.read();
        
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';
        
        for (const line of lines) {
          if (!line.trim()) continue;
          
          try {
            const data = JSON.parse(line);
            
            if (data.status === 'error') {
              throw new Error(data.error || 'Fout bij het genereren van blog');
            }
            
            if (data.status === 'complete') {
              // Final result
              setArticleTitle(data.title || topic);
              setGeneratedArticle(data.content);
              setProgress(100);
              setStatusMessage('‚úÖ Blog generatie voltooid!');
              toast.success(`Blog succesvol gegenereerd! (${data.creditsUsed} credits gebruikt)`);
            } else if (data.status) {
              // Status update
              setStatusMessage(data.status);
              setProgress(data.progress || 0);
            }
          } catch (parseError) {
            console.error('Error parsing stream:', parseError);
          }
        }
      }
    } catch (error: any) {
      console.error('Error generating blog:', error);
      toast.error(error.message || 'Fout bij het genereren van blog');
      setStatusMessage('');
    } finally {
      setLoading(false);
      setTimeout(() => {
        setProgress(0);
        setStatusMessage('');
      }, 2000);
    }
  };

  // Reset form
  const reset = () => {
    setTopic('');
    setKeywords('');
    setGeneratedArticle('');
    setArticleTitle('');
  };

  // Save blog to database
  const saveBlogToDatabase = async (content: string, autoSave: boolean = false) => {
    try {
      // Extract title from HTML
      const titleMatch = content.match(/<h1>(.*?)<\/h1>/);
      const title = titleMatch ? titleMatch[1] : articleTitle;

      // Extract keywords from content
      const keywordsList = keywords.split(',').map(k => k.trim()).filter(Boolean);

      const response = await fetch('/api/client/content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          content,
          keywords: keywordsList,
          metaDescription: `${title.substring(0, 155)}...`,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        if (!autoSave) {
          toast.success('‚úÖ Blog opgeslagen in je Content Bibliotheek!');
          // Clear localStorage
          localStorage.removeItem('blog-draft-content');
          localStorage.removeItem('blog-draft-timestamp');
          localStorage.removeItem('current-blog-content');
          localStorage.removeItem('current-blog-timestamp');
          // Reset and go back
          setTimeout(() => {
            reset();
          }, 1500);
        }
        return data.content;
      } else {
        throw new Error('Kon blog niet opslaan');
      }
    } catch (error: any) {
      console.error('Error saving blog:', error);
      if (!autoSave) {
        toast.error('Fout bij het opslaan van blog');
      }
      return null;
    }
  };

  // Render canvas if article is generated
  if (generatedArticle) {
    return (
      <BlogCanvas
        content={generatedArticle}
        isGenerating={false}
        topic={articleTitle}
        onSave={(content) => saveBlogToDatabase(content, true)}
      />
    );
  }

  return (
    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: BRAND_COLORS.navy }}>
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <Link href="/client-portal">
            <Button variant="ghost" className="mb-4 text-gray-300 hover:text-white hover:bg-[#003459]">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Terug naar overzicht
            </Button>
          </Link>
          
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 rounded-xl shadow-lg" style={{ backgroundColor: BRAND_COLORS.orange }}>
              <FileText className="w-7 h-7 text-white" />
            </div>
            <div>
              <h1 className="text-4xl font-bold" style={{ color: BRAND_COLORS.white }}>
                Blog Generator
              </h1>
              <p className="text-lg mt-1" style={{ color: '#8a8a8a' }}>
                SEO-geoptimaliseerde blogs met AI ‚Ä¢ 10 credits
              </p>
            </div>
          </div>
          
          {/* AI Models Badge */}
          <div className="mt-4 flex flex-wrap gap-2">
            <Badge variant="outline" className="border-[#FFA500] text-[#FFA500] bg-[#003459]">
              <Sparkles className="w-3 h-3 mr-1" />
              GPT-4o Search (Research)
            </Badge>
            <Badge variant="outline" className="border-[#4A90E2] text-[#4A90E2] bg-[#003459]">
              <Sparkles className="w-3 h-3 mr-1" />
              Claude 3.7 Sonnet (Writing)
            </Badge>
          </div>
        </div>

        {/* Progress bar with detailed status */}
        {progress > 0 && (
          <div className="mb-6 rounded-lg p-4 shadow-sm" style={{ backgroundColor: BRAND_COLORS.cardBg, borderColor: BRAND_COLORS.cardBorder, borderWidth: '1px' }}>
            <Progress value={progress} className="h-3 bg-[#002040]">
              <div 
                className="h-full transition-all duration-500"
                style={{ width: `${progress}%`, backgroundColor: BRAND_COLORS.orange }}
              />
            </Progress>
            <div className="mt-3 flex items-center justify-between">
              <p className="text-sm font-medium" style={{ color: '#b0c4d4' }}>
                {statusMessage || 'Blog genereren...'}
              </p>
              <Badge variant="outline" className="border-[#FFA500] text-[#FFA500] bg-[#002040]">
                {progress}%
              </Badge>
            </div>
          </div>
        )}

        <Card className="shadow-xl" style={{ backgroundColor: BRAND_COLORS.cardBg, borderColor: BRAND_COLORS.cardBorder }}>
          <CardHeader className="border-b" style={{ borderColor: BRAND_COLORS.cardBorder }}>
            <CardTitle className="flex items-center gap-2" style={{ color: BRAND_COLORS.white }}>
              <Settings2 className="w-5 h-5" style={{ color: BRAND_COLORS.orange }} />
              Blog Instellingen
            </CardTitle>
            <CardDescription style={{ color: '#8a8a8a' }}>
              Configureer je blog en laat de AI het schrijven
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6 pt-6">
            {/* Topic */}
            <div className="space-y-2">
              <Label htmlFor="topic" className="flex items-center gap-2 text-[#000814] font-semibold">
                <Target className="w-4 h-4 text-orange-500" />
                Onderwerp *
              </Label>
              <Textarea
                id="topic"
                value={topic}
                onChange={(e) => setTopic(e.target.value)}
                placeholder="Bijvoorbeeld: De toekomst van AI in marketing"
                rows={3}
                className="border-gray-300 focus:border-orange-500 focus:ring-orange-500"
              />
            </div>

            {/* Keywords */}
            <div className="space-y-2">
              <Label htmlFor="keywords" className="flex items-center gap-2 text-[#000814] font-semibold">
                <BarChart3 className="w-4 h-4 text-orange-500" />
                Keywords (optioneel)
              </Label>
              <Input
                id="keywords"
                value={keywords}
                onChange={(e) => setKeywords(e.target.value)}
                placeholder="AI, marketing, automatisering, trends"
                className="border-gray-300 focus:border-orange-500 focus:ring-orange-500"
              />
              <p className="text-xs text-gray-500">
                Gescheiden door komma's ‚Ä¢ Deze keywords worden natuurlijk verwerkt in de tekst
              </p>
            </div>

            {/* Sitemap URL voor interne links */}
            <div className="space-y-2">
              <Label htmlFor="sitemapUrl" className="flex items-center gap-2 text-[#000814] font-semibold">
                üîó Website URL (optioneel)
              </Label>
              <Input
                id="sitemapUrl"
                value={sitemapUrl}
                onChange={(e) => setSitemapUrl(e.target.value)}
                placeholder="https://www.jouwwebsite.nl"
                className="border-gray-300 focus:border-orange-500 focus:ring-orange-500"
              />
              <p className="text-xs text-gray-500">
                De AI voegt automatisch relevante interne links toe naar pagina's op je website
              </p>
            </div>

            {/* Row: Word count + Tone */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="wordCount" className="text-[#000814] font-semibold">
                  Woordaantal
                </Label>
                <Select value={wordCount} onValueChange={setWordCount}>
                  <SelectTrigger className="border-gray-300 focus:border-orange-500">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="500">500 woorden</SelectItem>
                    <SelectItem value="1000">1000 woorden</SelectItem>
                    <SelectItem value="1500">1500 woorden ‚≠ê</SelectItem>
                    <SelectItem value="2000">2000 woorden</SelectItem>
                    <SelectItem value="2500">2500+ woorden</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="tone" className="flex items-center gap-2 text-[#000814] font-semibold">
                  <PenTool className="w-4 h-4 text-orange-500" />
                  Toon
                </Label>
                <Select value={tone} onValueChange={setTone}>
                  <SelectTrigger className="border-gray-300 focus:border-orange-500">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="professional">Professioneel</SelectItem>
                    <SelectItem value="casual">Casual</SelectItem>
                    <SelectItem value="expert">Expert</SelectItem>
                    <SelectItem value="friendly">Vriendelijk</SelectItem>
                    <SelectItem value="formal">Formeel</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Row: Language + Project */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="language" className="text-[#000814] font-semibold">Taal</Label>
                <Select value={language} onValueChange={setLanguage}>
                  <SelectTrigger className="border-gray-300 focus:border-orange-500">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="nl">üá≥üá± Nederlands</SelectItem>
                    <SelectItem value="en">üá¨üáß Engels</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="project" className="text-[#000814] font-semibold">
                  Project (optioneel)
                </Label>
                <Select 
                  value={projectId} 
                  onValueChange={setProjectId}
                  disabled={loadingProjects}
                >
                  <SelectTrigger className="border-gray-300 focus:border-orange-500">
                    <SelectValue placeholder="Selecteer project" />
                  </SelectTrigger>
                  <SelectContent>
                    {projects.map((project) => (
                      <SelectItem key={project.id || 'none'} value={project.id || 'none'}>
                        {project.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Switches */}
            <div className="space-y-4 pt-4 border-t">
              <div className="flex items-center justify-between p-4 bg-orange-50 rounded-lg border border-orange-200">
                <div className="space-y-0.5">
                  <Label className="text-[#000814] font-semibold">SEO Optimalisatie</Label>
                  <p className="text-sm text-gray-600">
                    Geoptimaliseerd voor zoekmachines
                  </p>
                </div>
                <Switch
                  checked={seoOptimized}
                  onCheckedChange={setSeoOptimized}
                  className="data-[state=checked]:bg-orange-500"
                />
              </div>

              <div className="space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label className="text-[#000814] font-semibold">Afbeeldingen toevoegen</Label>
                    <p className="text-sm text-gray-600">
                      Genereer automatisch passende afbeeldingen met AI
                    </p>
                  </div>
                  <Switch
                    checked={includeImage}
                    onCheckedChange={setIncludeImage}
                    className="data-[state=checked]:bg-blue-500"
                  />
                </div>
                
                {includeImage && (
                  <div className="space-y-2 pt-2 border-t border-blue-200">
                    <Label htmlFor="imageStyle" className="text-[#000814] font-semibold text-sm">
                      Afbeeldingsstijl
                    </Label>
                    <Select value={imageStyle} onValueChange={setImageStyle}>
                      <SelectTrigger className="border-blue-300 focus:border-blue-500 bg-white">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="realistic">üé® Realistisch</SelectItem>
                        <SelectItem value="illustration">‚úèÔ∏è Illustratie</SelectItem>
                        <SelectItem value="minimalist">‚ö™ Minimalistisch</SelectItem>
                        <SelectItem value="modern">üåü Modern</SelectItem>
                        <SelectItem value="professional">üíº Professioneel</SelectItem>
                        <SelectItem value="creative">üé≠ Creatief</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                )}
              </div>
            </div>

            {/* Generate button */}
            <Button 
              onClick={generateBlog} 
              disabled={loading || !topic.trim()}
              className="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
              size="lg"
            >
              {loading ? (
                <>
                  <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                  Blog genereren...
                </>
              ) : (
                <>
                  <Sparkles className="w-5 h-5 mr-2" />
                  Genereer Blog ‚Ä¢ 10 Credits
                </>
              )}
            </Button>

            {/* Info */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
              <p className="text-sm text-blue-900">
                <strong className="text-orange-600">üí° Tip:</strong> Voor beste resultaten, voer een specifiek onderwerp in en voeg relevante keywords toe. De AI voert automatisch actueel web research uit voordat het blog wordt geschreven.
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
