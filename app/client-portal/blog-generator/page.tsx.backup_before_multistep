'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  FileText, 
  Loader2, 
  Sparkles,
  Settings2,
  Target,
  PenTool,
  BarChart3,
  ArrowLeft,
  ShoppingBag,
  Star,
  List,
  Plus,
  X,
  ChevronRight,
  ChevronLeft,
  Check,
  ListOrdered,
  Edit3,
  ChevronUp,
  ChevronDown
} from 'lucide-react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { toast } from 'sonner';
import BlogCanvas from '@/components/blog-canvas';
import ProjectSelector, { Project } from '@/components/project-selector';
import BolcomProductSelector, { SelectedProduct } from '@/components/bolcom-product-selector';
import Link from 'next/link';
import Image from 'next/image';

// OLD Product interface - VERWIJDERD (niet meer nodig)
// interface Product {
//   name: string;
//   url: string;
//   price?: string;
//   rating?: string;
//   description?: string;
// }

// Outline item interface
interface OutlineItem {
  id: string;
  heading: string;
  subheadings: string[];
}

export default function BlogGenerator() {
  const { data: session } = useSession() || {};
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState(0);
  
  // üìù MULTISTEP WIZARD STATE
  const [currentStep, setCurrentStep] = useState(1);
  const totalSteps = 5;
  
  // üìã OUTLINE STATE
  const [outline, setOutline] = useState<OutlineItem[]>([]);
  const [outlineLoading, setOutlineLoading] = useState(false);
  const [outlineDialogOpen, setOutlineDialogOpen] = useState(false);
  
  // Content type - REMOVED: intelligent detection handles everything automatically
  // const [contentType, setContentType] = useState<'blog' | 'product-review' | 'top-list'>('blog');
  
  // Form state - Blog
  const [topic, setTopic] = useState('');
  const [keywords, setKeywords] = useState('');
  const [wordCount, setWordCount] = useState('1500');
  const [tone, setTone] = useState('professional');
  const [language, setLanguage] = useState('nl');
  const [seoOptimized, setSeoOptimized] = useState(true);
  const [includeImage, setIncludeImage] = useState(true);
  const [imageStyle, setImageStyle] = useState('realistic');
  const [projectId, setProjectId] = useState<string | null>(null);
  const [selectedProject, setSelectedProject] = useState<Project | null>(null);
  const [sitemapUrl, setSitemapUrl] = useState('');
  
  // üõí AFFILIATE PLATFORM SELECTOR
  const [affiliatePlatform, setAffiliatePlatform] = useState<'bolcom' | 'custom' | 'none'>('none');
  const [selectedProducts, setSelectedProducts] = useState<SelectedProduct[]>([]);
  
  // üîó CUSTOM AFFILIATE LINKS
  const [customAffiliateLinks, setCustomAffiliateLinks] = useState<Array<{ name: string; url: string }>>([{ name: '', url: '' }]);
  
  // üé® LINK DISPLAY TYPE SELECTOR
  const [linkDisplayType, setLinkDisplayType] = useState<'inline' | 'product-box' | 'cta-box' | 'button' | 'ai-mix'>('product-box');
  
  // ‚ú® NIEUWE SEO OPTIES
  const [includeYouTube, setIncludeYouTube] = useState(false);
  const [includeFAQ, setIncludeFAQ] = useState(true);
  const [includeDirectAnswer, setIncludeDirectAnswer] = useState(true);
  const [generateFeaturedImage, setGenerateFeaturedImage] = useState(true);
  
  // üéØ WORDPRESS PUBLICATIE OPTIES
  const [wpCategories, setWpCategories] = useState<Array<{ id: number; name: string }>>([]);
  const [selectedCategory, setSelectedCategory] = useState<string>('');
  const [seoTitle, setSeoTitle] = useState('');
  const [seoDescription, setSeoDescription] = useState('');
  const [focusKeyword, setFocusKeyword] = useState('');
  
  // OLD Product Review velden - VERWIJDERD (AI detecteert nu automatisch)
  // const [category, setCategory] = useState('');
  // const [reviewType, setReviewType] = useState<'single' | 'comparison'>('single');
  // const [targetAudience, setTargetAudience] = useState('');
  // const [products, setProducts] = useState<Product[]>([{ name: '', url: '' }]);
  // const [additionalContext, setAdditionalContext] = useState('');
  
  // Generated content
  const [generatedArticle, setGeneratedArticle] = useState('');
  const [articleTitle, setArticleTitle] = useState('');
  const [seoMetadata, setSeoMetadata] = useState<any>(null);
  const [featuredImage, setFeaturedImage] = useState<string>('');
  const [socialMediaPost, setSocialMediaPost] = useState<any>(null);
  
  // Status updates
  const [statusMessage, setStatusMessage] = useState('');

  // Check authentication
  useEffect(() => {
    if (!session) {
      router.push('/client-login');
    }
  }, [session, router]);

  // Pre-fill from URL parameters (from keyword research)
  useEffect(() => {
    const searchParams = new URLSearchParams(window.location.search);
    const fromResearch = searchParams.get('from');
    
    if (fromResearch === 'research') {
      // Get all parameters
      const titleParam = searchParams.get('title');
      const keywordParam = searchParams.get('keyword');
      const keywordsParam = searchParams.get('keywords');
      const contentTypeParam = searchParams.get('contentType');
      const projectIdParam = searchParams.get('projectId');
      
      // Pre-fill form
      if (titleParam) {
        setTopic(titleParam);
        // Auto-fill SEO title with the topic
        setSeoTitle(titleParam);
      }
      
      // Combine keyword + keywords
      const allKeywords = [keywordParam, keywordsParam].filter(Boolean).join(', ');
      if (allKeywords) {
        setKeywords(allKeywords);
        // Set first keyword as focus keyword
        const firstKeyword = keywordParam || keywordsParam?.split(',')[0];
        if (firstKeyword) setFocusKeyword(firstKeyword.trim());
      }
      
      // Content type mapping VERWIJDERD - AI detecteert nu automatisch
      // contentTypeParam wordt genegeerd, AI analyseert het onderwerp zelf
      
      if (projectIdParam) setProjectId(projectIdParam);
      
      // Show success message
      setTimeout(() => {
        toast.success('Content idee geladen! Pas aan indien nodig en klik op "Genereer Content".');
      }, 500);
    }
  }, []);
  
  // ü§ñ OUDE AUTO-DETECTIE LOGICA VERWIJDERD
  // De AI op de backend detecteert nu automatisch het content type
  // tijdens het genereren op basis van het onderwerp

  // Auto-fill SEO fields when topic changes
  useEffect(() => {
    if (topic && !seoTitle) {
      setSeoTitle(topic);
    }
    if (keywords && !focusKeyword) {
      const firstKeyword = keywords.split(',')[0]?.trim();
      if (firstKeyword) setFocusKeyword(firstKeyword);
    }
  }, [topic, keywords]);

  // Handle project selection
  const handleProjectChange = (newProjectId: string | null, project: Project | null) => {
    setProjectId(newProjectId);
    setSelectedProject(project);
    
    // Auto-fill sitemap URL when project is selected
    if (project?.websiteUrl) {
      console.log('üîó Auto-filling sitemap URL from project:', project.websiteUrl);
      setSitemapUrl(project.websiteUrl);
      
      // Also update tone if available from project
      if (project.toneOfVoice) {
        setTone(project.toneOfVoice.toLowerCase());
      }
      // targetAudience verwijderd - niet meer nodig
    } else {
      setSitemapUrl('');
    }
    
    // üöÄ OPTIMIZATION: Don't fetch WordPress categories automatically
    // They will be loaded lazily when user expands WordPress settings
    // Reset categories when project changes
    setWpCategories([]);
    setSelectedCategory('');
  };
  
  // Fetch WordPress categories
  const fetchWordPressCategories = async (projectId: string) => {
    try {
      const response = await fetch('/api/client/wordpress-categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectId }),
      });
      
      const data = await response.json();
      
      if (data.categories && data.categories.length > 0) {
        setWpCategories(data.categories);
        console.log('‚úÖ WordPress categories loaded:', data.categories.length);
      } else {
        setWpCategories([]);
        console.log('‚ÑπÔ∏è No WordPress categories found or WordPress not configured');
      }
    } catch (error) {
      console.error('Error fetching WordPress categories:', error);
      setWpCategories([]);
    }
  };

  // OLD Product management functions - VERWIJDERD (niet meer nodig)
  // const addProduct = () => {
  //   setProducts([...products, { name: '', url: '' }]);
  // };
  // const removeProduct = (index: number) => { ... };
  // const updateProduct = (index: number, field: keyof Product, value: string) => { ... };
  // const scrapeProduct = async (index: number) => { ... };

  // REMOVED: Old affiliate link management functions - replaced by platform selector

  // üìã OUTLINE MANAGEMENT FUNCTIONS
  
  // Generate outline
  const generateOutline = async () => {
    if (!topic.trim()) {
      toast.error('Voer een onderwerp in');
      return;
    }

    setOutlineLoading(true);
    
    try {
      const response = await fetch('/api/client/generate-outline', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          topic,
          keywords: keywords.split(',').map(k => k.trim()).filter(Boolean),
          language,
          tone,
          projectId: projectId || undefined,
          sitemapUrl: sitemapUrl || undefined,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Fout bij het genereren van outline');
      }

      // Transform outline to editable format
      const outlineItems: OutlineItem[] = data.outline.map((item: any, index: number) => ({
        id: `outline-${index}`,
        heading: item.heading || item.title || '',
        subheadings: item.subheadings || item.points || [],
      }));

      setOutline(outlineItems);
      toast.success('Outline succesvol gegenereerd!');
      
      // Open dialog to show outline
      setOutlineDialogOpen(true);
    } catch (error: any) {
      console.error('Error generating outline:', error);
      toast.error(error.message || 'Fout bij het genereren van outline');
    } finally {
      setOutlineLoading(false);
    }
  };

  // Add new outline section
  const addOutlineSection = () => {
    const newItem: OutlineItem = {
      id: `outline-${Date.now()}`,
      heading: '',
      subheadings: [''],
    };
    setOutline([...outline, newItem]);
  };

  // Update outline section
  const updateOutlineHeading = (id: string, heading: string) => {
    setOutline(outline.map(item => 
      item.id === id ? { ...item, heading } : item
    ));
  };

  // Add subheading to section
  const addSubheading = (id: string) => {
    setOutline(outline.map(item => 
      item.id === id ? { ...item, subheadings: [...item.subheadings, ''] } : item
    ));
  };

  // Update subheading
  const updateSubheading = (id: string, index: number, value: string) => {
    setOutline(outline.map(item => {
      if (item.id === id) {
        const newSubheadings = [...item.subheadings];
        newSubheadings[index] = value;
        return { ...item, subheadings: newSubheadings };
      }
      return item;
    }));
  };

  // Remove subheading
  const removeSubheading = (id: string, index: number) => {
    setOutline(outline.map(item => {
      if (item.id === id && item.subheadings.length > 1) {
        const newSubheadings = item.subheadings.filter((_, i) => i !== index);
        return { ...item, subheadings: newSubheadings };
      }
      return item;
    }));
  };

  // Remove outline section
  const removeOutlineSection = (id: string) => {
    if (outline.length > 1) {
      setOutline(outline.filter(item => item.id !== id));
    } else {
      toast.error('Je moet minimaal √©√©n sectie hebben');
    }
  };

  // Move section up
  const moveOutlineSectionUp = (id: string) => {
    const index = outline.findIndex(item => item.id === id);
    if (index > 0) {
      const newOutline = [...outline];
      [newOutline[index - 1], newOutline[index]] = [newOutline[index], newOutline[index - 1]];
      setOutline(newOutline);
    }
  };

  // Move section down
  const moveOutlineSectionDown = (id: string) => {
    const index = outline.findIndex(item => item.id === id);
    if (index < outline.length - 1) {
      const newOutline = [...outline];
      [newOutline[index], newOutline[index + 1]] = [newOutline[index + 1], newOutline[index]];
      setOutline(newOutline);
    }
  };

  // üöÄ MULTISTEP NAVIGATION
  
  const goToNextStep = () => {
    // Validation per step
    if (currentStep === 1) {
      if (!topic.trim()) {
        toast.error('Voer een onderwerp in');
        return;
      }
    }
    
    if (currentStep === 3 && affiliatePlatform === 'bolcom' && selectedProducts.length === 0) {
      toast.warning('Selecteer minimaal √©√©n product of kies "Geen affiliate"');
      return;
    }
    
    if (currentStep < totalSteps) {
      setCurrentStep(currentStep + 1);
    }
  };

  const goToPrevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const skipToGeneration = () => {
    if (!topic.trim()) {
      toast.error('Voer een onderwerp in');
      return;
    }
    // Skip outline and go straight to generation
    setCurrentStep(5);
  };

  // Generate content
  const generateContent = async () => {
    // Validation - alleen topic vereist, AI detecteert automatisch het type
    if (!topic.trim()) {
      toast.error('Voer een onderwerp in');
      return;
    }

    setLoading(true);
    setProgress(0);
    setStatusMessage('üöÄ Content generatie starten...');

    try {
      // üéØ INTELLIGENTE CONTENT GENERATOR - Detecteert automatisch type
      const response = await fetch('/api/client/generate-blog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          // Onderwerp - AI detecteert automatisch het content type
          topic,
          keywords: keywords.split(',').map(k => k.trim()).filter(Boolean),
          wordCount: parseInt(wordCount),
          tone,
          language,
          seoOptimized,
          includeImage,
          imageStyle,
          projectId: projectId || undefined,
          sitemapUrl: sitemapUrl || undefined,
          
          // üìã Custom outline (if available)
          outline: outline.length > 0 ? outline.map(item => ({
            heading: item.heading,
            subheadings: item.subheadings.filter(sh => sh.trim()),
          })).filter(item => item.heading.trim()) : undefined,
          
          // üõí Affiliate producten (Bol.com of custom)
          products: affiliatePlatform === 'bolcom' 
            ? selectedProducts.map(p => ({
                name: p.title, // API verwacht 'name'
                url: p.affiliateUrl,
                price: p.price ? `‚Ç¨${p.price.toFixed(2)}` : undefined,
                rating: p.rating ? `${p.rating.toFixed(1)}/5` : undefined,
                description: p.notes || undefined,
                imageUrl: p.image || undefined, // Voor CTA boxes
              }))
            : affiliatePlatform === 'custom'
            ? customAffiliateLinks
                .filter(link => link.name && link.url)
                .map(link => ({
                  name: link.name,
                  url: link.url,
                }))
            : [],
          
          // üé® Link Display Type
          linkDisplayType,
          
          // SEO opties
          includeYouTube,
          includeFAQ,
          includeDirectAnswer,
          generateFeaturedImage,
        }),
      });

      if (!response.ok) {
        throw new Error('Fout bij het genereren van content');
      }

      // Read streaming response with improved handling
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let finalDataReceived = false;
      let allChunks: string[] = [];

      if (!reader) {
        throw new Error('Geen response stream');
      }

      console.log('üì° Starting to read stream...');

      while (true) {
        const { done, value } = await reader.read();
        
        if (value) {
          const chunk = decoder.decode(value, { stream: true });
          buffer += chunk;
          allChunks.push(chunk);
          console.log('üì¶ Received chunk:', chunk.substring(0, 100));
        }
        
        // Process all complete lines in the buffer
        const lines = buffer.split('\n');
        
        // Keep the last incomplete line in the buffer (unless we're done)
        if (!done) {
          buffer = lines.pop() || '';
        } else {
          buffer = '';
        }
        
        // Process each complete line
        for (const line of lines) {
          if (!line.trim()) continue;
          
          try {
            const data = JSON.parse(line);
            
            console.log('üì• Parsed data:', { 
              status: data.status, 
              progress: data.progress,
              success: data.success,
              hasContent: !!data.content,
              contentLength: data.content?.length,
            });
            
            // Check for errors
            if (data.status === 'error' || data.error) {
              throw new Error(data.error || 'Fout bij het genereren van content');
            }
            
            // Update progress for all status messages
            if (typeof data.progress === 'number') {
              setProgress(data.progress);
              console.log(`üìä Progress updated to: ${data.progress}%`);
            }
            
            // Update status message
            if (data.status && typeof data.status === 'string') {
              setStatusMessage(data.status);
            }
            
            // Check for completion with content
            if ((data.status === 'complete' || data.success === true) && data.content && !finalDataReceived) {
              finalDataReceived = true;
              console.log('‚úÖ Generation complete! Processing final data...');
              
              const title = data.title || topic;
              const content = data.content || '';
              
              console.log('üìù Final article data:', {
                title,
                contentLength: content.length,
                contentPreview: content.substring(0, 200),
                hasSeoMetadata: !!data.seoMetadata,
                hasFeaturedImage: !!data.featuredImage,
              });
              
              if (content && content.length > 0) {
                // ‚úÖ FORCE progress to 100% and set loading false BEFORE setting content
                setProgress(100);
                setStatusMessage('‚úÖ Content gereed! Editor openen...');
                
                // Small delay to ensure UI updates
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Now set all content state - this will trigger the BlogCanvas render
                setArticleTitle(title);
                setSeoMetadata(data.seoMetadata || null);
                setFeaturedImage(data.featuredImage || '');
                setSocialMediaPost(data.socialMediaPost || null);
                setLoading(false);
                
                // ‚úÖ Set generated article LAST to trigger the BlogCanvas render
                setGeneratedArticle(content);
                
                toast.success(`Content succesvol gegenereerd! (${data.creditsUsed || 50} credits gebruikt)`);
                
                console.log('‚úÖ All article state updated - transitioning to editor now');
                
                // ‚úÖ Break immediately after setting final state
                return;
              } else {
                console.warn('‚ö†Ô∏è Received completion but no content!');
                throw new Error('Geen content ontvangen');
              }
            }
          } catch (parseError) {
            console.error('‚ùå Error parsing line:', parseError);
            console.error('‚ùå Problematic line:', line);
          }
        }
        
        if (done) {
          console.log('üì° Stream ended');
          console.log('üìä Total chunks received:', allChunks.length);
          console.log('üìä Final data received:', finalDataReceived);
          break;
        }
      }
      
      // Final check: if we didn't receive final data, something went wrong
      if (!finalDataReceived) {
        console.error('‚ùå Stream ended without receiving final data');
        console.error('‚ùå All chunks:', allChunks.join(''));
        throw new Error('Content generatie niet voltooid - probeer het opnieuw');
      }
      
      console.log('‚úÖ Stream processing completed successfully');
    } catch (error: any) {
      console.error('Error generating content:', error);
      toast.error(error.message || 'Fout bij het genereren van content');
      setStatusMessage('');
      setLoading(false);
    }
    // No finally block - don't reset anything automatically
  };

  // Reset form
  const reset = () => {
    setTopic('');
    setKeywords('');
    // Oude velden verwijderd: category, products, additionalContext
    setGeneratedArticle('');
    setArticleTitle('');
    setSeoMetadata(null);
    setFeaturedImage('');
    setSocialMediaPost(null);
    setAffiliatePlatform('none');
    setSelectedProducts([]);
  };


  // Render canvas if article is generated
  if (generatedArticle) {
    return (
      <BlogCanvas
        content={generatedArticle}
        isGenerating={false}
        topic={articleTitle}
        seoMetadata={seoMetadata}
        featuredImage={featuredImage} // Nieuwe featured image prop
        socialMediaPost={socialMediaPost} // Social media post prop
      />
    );
  }

  return (
    <div className="min-h-screen p-4 md:p-8 bg-black">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <Link href="/client-portal">
            <Button variant="ghost" className="mb-4 text-gray-400 hover:text-white hover:bg-zinc-800">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Terug naar overzicht
            </Button>
          </Link>
          
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 rounded-xl shadow-lg bg-gradient-to-br from-[#ff6b35] to-[#ff8c42]">
              <FileText className="w-7 h-7 text-white" />
            </div>
            <div>
              <h1 className="text-4xl font-bold text-white">
                ü§ñ Intelligente Content Generator
              </h1>
              <p className="text-lg mt-1 text-gray-400">
                Herkent automatisch welk type content je wilt maken
              </p>
            </div>
          </div>
          
          {/* Intelligente Content Detectie Info */}
          <div className="mt-6 space-y-3">
            {/* Auto-detectie badge - altijd tonen */}
            <div className="flex items-center gap-2 p-4 bg-gradient-to-r from-[#ff6b35]/10 to-orange-800/10 border border-[#ff6b35]/30 rounded-lg">
              <Sparkles className="w-5 h-5 text-[#ff6b35] animate-pulse" />
              <div className="flex-1">
                <span className="text-sm text-orange-100 font-medium block">
                  ü§ñ Intelligente Content Generator
                </span>
                <span className="text-xs text-gray-400 block mt-0.5">
                  Detecteert automatisch: Blog, Review, Top Lijst, How-to, Vergelijking en meer
                </span>
              </div>
              <Badge variant="outline" className="border-[#ff6b35] text-[#ff6b35] bg-[#ff6b35]/10">
                AI Auto-detectie
              </Badge>
            </div>
          </div>
          
          {/* AI Models Badge */}
          <div className="mt-4 flex flex-wrap gap-2">
            <Badge variant="outline" className="border-[#ff6b35] text-[#ff6b35] bg-zinc-900">
              <Sparkles className="w-3 h-3 mr-1" />
              GPT-4o Search (Research)
            </Badge>
            <Badge variant="outline" className="border-blue-500 text-blue-400 bg-zinc-900">
              <Sparkles className="w-3 h-3 mr-1" />
              Claude 4.5 Sonnet ‚≠ê
            </Badge>
          </div>
        </div>

        {/* Progress bar with detailed status */}
        {progress > 0 && (
          <div className="mb-6 rounded-lg p-4 shadow-md bg-zinc-900 border border-zinc-800">
            <Progress value={progress} className="h-3 bg-zinc-700">
              <div 
                className="h-full transition-all duration-500 bg-gradient-to-r from-[#ff6b35] to-[#ff8c42]"
                style={{ width: `${progress}%` }}
              />
            </Progress>
            <div className="mt-3 flex items-center justify-between">
              <p className="text-sm font-medium text-gray-200">
                {statusMessage || 'Content genereren...'}
              </p>
              <Badge variant="outline" className="border-[#ff6b35] text-[#ff6b35] bg-zinc-900">
                {progress}%
              </Badge>
            </div>
          </div>
        )}

        {/* Multistep Progress Indicator */}
        <div className="mb-6">
          <div className="flex items-center justify-between mb-2">
            {[1, 2, 3, 4, 5].map((step) => (
              <div key={step} className="flex items-center flex-1">
                <div 
                  className={`
                    flex items-center justify-center w-10 h-10 rounded-full font-semibold
                    ${currentStep === step 
                      ? 'bg-gradient-to-br from-[#ff6b35] to-[#ff8c42] text-white' 
                      : currentStep > step
                      ? 'bg-green-600 text-white'
                      : 'bg-zinc-800 text-gray-500'
                    }
                  `}
                >
                  {currentStep > step ? <Check className="w-5 h-5" /> : step}
                </div>
                {step < 5 && (
                  <div 
                    className={`
                      flex-1 h-1 mx-2
                      ${currentStep > step ? 'bg-green-600' : 'bg-zinc-800'}
                    `}
                  />
                )}
              </div>
            ))}
          </div>
          <div className="flex justify-between text-xs text-gray-400 mt-2">
            <span className={currentStep === 1 ? 'text-[#ff6b35] font-semibold' : ''}>Basis</span>
            <span className={currentStep === 2 ? 'text-[#ff6b35] font-semibold' : ''}>Opties</span>
            <span className={currentStep === 3 ? 'text-[#ff6b35] font-semibold' : ''}>Affiliate</span>
            <span className={currentStep === 4 ? 'text-[#ff6b35] font-semibold' : ''}>Outline</span>
            <span className={currentStep === 5 ? 'text-[#ff6b35] font-semibold' : ''}>Genereren</span>
          </div>
        </div>

        <Card className="bg-zinc-900 border-zinc-800 shadow-xl">
          <CardHeader className="border-b border-zinc-800">
            <CardTitle className="flex items-center gap-2 text-white">
              <Settings2 className="w-5 h-5 text-[#ff6b35]" />
              {currentStep === 1 && 'Stap 1: Basis Instellingen'}
              {currentStep === 2 && 'Stap 2: Content Opties'}
              {currentStep === 3 && 'Stap 3: Affiliate Integratie'}
              {currentStep === 4 && 'Stap 4: Outline Editor'}
              {currentStep === 5 && 'Stap 5: Review & Genereren'}
            </CardTitle>
            <CardDescription className="text-gray-300">
              {currentStep === 1 && 'Vul de basisinformatie in voor je content'}
              {currentStep === 2 && 'Configureer content opties zoals SEO en afbeeldingen'}
              {currentStep === 3 && 'Voeg optioneel affiliate links toe (Bol.com of custom)'}
              {currentStep === 4 && 'Bewerk de outline voor je content (optioneel)'}
              {currentStep === 5 && 'Controleer alles en genereer je content'}
            </CardDescription>
          </CardHeader>
            {/* STEP 1: BASIS INSTELLINGEN */}
            {currentStep === 1 && (
              <div className="space-y-6">
                {/* Topic */}
                <div className="space-y-2">
                  <Label htmlFor="topic" className="flex items-center gap-2 text-white font-semibold">
                    <Target className="w-4 h-4 text-[#ff6b35]" />
                    Onderwerp *
                  </Label>
                  <Textarea
                    id="topic"
                    value={topic}
                    onChange={(e) => setTopic(e.target.value)}
                    placeholder="Bijvoorbeeld: De toekomst van AI in marketing"
                    rows={3}
                    className="border-zinc-700 focus:border-[#ff6b35] focus:ring-[#ff6b35] bg-zinc-900 text-white placeholder:text-gray-300"
                  />
                </div>

                {/* Keywords */}
                <div className="space-y-2">
                  <Label htmlFor="keywords" className="flex items-center gap-2 text-white font-semibold">
                    <BarChart3 className="w-4 h-4 text-[#ff6b35]" />
                    Keywords (optioneel)
                  </Label>
                  <Input
                    id="keywords"
                    value={keywords}
                    onChange={(e) => setKeywords(e.target.value)}
                    placeholder="AI, marketing, automatisering, trends"
                    className="border-zinc-700 focus:border-[#ff6b35] focus:ring-[#ff6b35] bg-zinc-900 text-white placeholder:text-gray-300"
                  />
                  <p className="text-xs text-gray-300">
                    Gescheiden door komma's ‚Ä¢ Deze keywords worden natuurlijk verwerkt in de tekst
                  </p>
                </div>

                {/* Row: Language + Tone */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="language" className="text-white font-semibold">Taal</Label>
                    <Select value={language} onValueChange={setLanguage}>
                      <SelectTrigger className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="nl">üá≥üá± Nederlands</SelectItem>
                        <SelectItem value="en">üá¨üáß Engels</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="tone" className="flex items-center gap-2 text-white font-semibold">
                      <PenTool className="w-4 h-4 text-[#ff6b35]" />
                      Toon
                    </Label>
                    <Select value={tone} onValueChange={setTone}>
                      <SelectTrigger className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="professional">Professioneel</SelectItem>
                        <SelectItem value="casual">Casual</SelectItem>
                        <SelectItem value="expert">Expert</SelectItem>
                        <SelectItem value="helpful">Behulpzaam</SelectItem>
                        <SelectItem value="friendly">Vriendelijk</SelectItem>
                        <SelectItem value="formal">Formeel</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* Project Selection */}
                <div className="space-y-2">
                  <Label htmlFor="project" className="text-white font-semibold">
                    Project (optioneel)
                  </Label>
                  <ProjectSelector
                    value={projectId}
                    onChange={handleProjectChange}
                    autoSelectPrimary={false}
                    showKnowledgeBase={true}
                  />
                  <p className="text-xs text-gray-300">
                    Koppel aan een project voor automatische tone-of-voice en sitemap URL
                  </p>
                </div>

                {/* Sitemap URL voor interne links */}
                <div className="space-y-2">
                  <Label htmlFor="sitemapUrl" className="flex items-center gap-2 text-white font-semibold">
                    üîó Website URL (optioneel)
                  </Label>
                  <Input
                    id="sitemapUrl"
                    value={sitemapUrl}
                    onChange={(e) => setSitemapUrl(e.target.value)}
                    placeholder="https://www.jouwwebsite.nl"
                    className="border-zinc-700 focus:border-[#ff6b35] focus:ring-[#ff6b35] bg-zinc-900 text-white placeholder:text-gray-300"
                  />
                  <p className="text-xs text-gray-300">
                    De AI voegt automatisch relevante interne links toe naar pagina's op je website
                  </p>
                </div>
              </div>
            )}

            {/* STEP 2: CONTENT OPTIES */}
            {currentStep === 2 && (
              <div className="space-y-6">
                {/* Word count */}
                <div className="space-y-2">
                  <Label htmlFor="wordCount" className="text-white font-semibold">
                    Woordaantal
                  </Label>
                  <Select value={wordCount} onValueChange={setWordCount}>
                    <SelectTrigger className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="500">500 woorden</SelectItem>
                      <SelectItem value="1000">1000 woorden</SelectItem>
                      <SelectItem value="1500">1500 woorden ‚≠ê</SelectItem>
                      <SelectItem value="2000">2000 woorden</SelectItem>
                      <SelectItem value="2500">2500+ woorden</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* SEO Options */}
                <div className="space-y-4 pt-4 border-t border-zinc-700">
                  <div className="flex items-center justify-between p-4 bg-zinc-900 rounded-lg border border-[#ff6b35]">
                    <div className="space-y-0.5">
                      <Label className="text-white font-semibold">SEO Optimalisatie</Label>
                      <p className="text-sm text-gray-300">
                        Geoptimaliseerd voor zoekmachines
                      </p>
                    </div>
                    <Switch
                      checked={seoOptimized}
                      onCheckedChange={setSeoOptimized}
                      className="data-[state=checked]:bg-[#ff6b35]"
                    />
                  </div>

                  <div className="space-y-3 p-4 bg-zinc-900 rounded-lg border border-blue-300">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-white font-semibold">Afbeeldingen toevoegen</Label>
                        <p className="text-sm text-gray-300">
                          Haal automatisch passende afbeeldingen op
                        </p>
                      </div>
                      <Switch
                        checked={includeImage}
                        onCheckedChange={setIncludeImage}
                        className="data-[state=checked]:bg-blue-500"
                      />
                    </div>
                    
                    {includeImage && (
                      <div className="space-y-2 pt-2 border-t border-zinc-700">
                        <Label htmlFor="imageStyle" className="text-white font-semibold text-sm">
                          Afbeeldingsstijl
                        </Label>
                        <Select value={imageStyle} onValueChange={setImageStyle}>
                          <SelectTrigger className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="realistic">üé® Realistisch</SelectItem>
                            <SelectItem value="illustration">‚úèÔ∏è Illustratie</SelectItem>
                            <SelectItem value="minimalist">‚ö™ Minimalistisch</SelectItem>
                            <SelectItem value="modern">üåü Modern</SelectItem>
                            <SelectItem value="professional">üíº Professioneel</SelectItem>
                            <SelectItem value="creative">üé≠ Creatief</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    )}
                  </div>

                  {/* ‚ú® NIEUWE SEO OPTIES */}
                  <div className="flex items-center justify-between p-4 bg-zinc-900 rounded-lg border border-purple-500">
                    <div className="space-y-0.5">
                      <Label className="text-white font-semibold">‚ùì FAQ Sectie</Label>
                      <p className="text-sm text-gray-300">
                        Voeg veelgestelde vragen toe aan het einde
                      </p>
                    </div>
                    <Switch
                      checked={includeFAQ}
                      onCheckedChange={setIncludeFAQ}
                      className="data-[state=checked]:bg-purple-500"
                    />
                  </div>

                  <div className="flex items-center justify-between p-4 bg-zinc-900 rounded-lg border border-green-500">
                    <div className="space-y-0.5">
                      <Label className="text-white font-semibold">üéØ Direct Antwoord Box</Label>
                      <p className="text-sm text-gray-300">
                        Voeg een direct antwoord toe na de introductie
                      </p>
                    </div>
                    <Switch
                      checked={includeDirectAnswer}
                      onCheckedChange={setIncludeDirectAnswer}
                      className="data-[state=checked]:bg-green-500"
                    />
                  </div>

                  <div className="flex items-center justify-between p-4 bg-zinc-900 rounded-lg border border-red-500">
                    <div className="space-y-0.5">
                      <Label className="text-white font-semibold">üé• YouTube Video</Label>
                      <p className="text-sm text-gray-300">
                        Embed een relevante YouTube video in de tekst
                      </p>
                    </div>
                    <Switch
                      checked={includeYouTube}
                      onCheckedChange={setIncludeYouTube}
                      className="data-[state=checked]:bg-red-500"
                    />
                  </div>

                  <div className="flex items-center justify-between p-4 bg-zinc-900 rounded-lg border border-yellow-500">
                    <div className="space-y-0.5">
                      <Label className="text-white font-semibold">üé® Featured Image (16:9)</Label>
                      <p className="text-sm text-gray-300">
                        Genereer een professionele header afbeelding
                      </p>
                    </div>
                    <Switch
                      checked={generateFeaturedImage}
                      onCheckedChange={setGenerateFeaturedImage}
                      className="data-[state=checked]:bg-yellow-500"
                    />
                  </div>
                </div>
              </div>
            )}

            {/* STEP 3: AFFILIATE INTEGRATIE */}
            {currentStep === 3 && (
              <div className="space-y-6">
                <div>
                  <Label className="flex items-center gap-2 text-white font-semibold mb-1">
                    <ShoppingBag className="w-4 h-4 text-[#ff6b35]" />
                    Affiliate Producten (optioneel)
                  </Label>
                  <p className="text-sm text-gray-300 mb-3">
                    Voeg producten toe via affiliate netwerken die automatisch in de tekst worden verwerkt
                  </p>
                </div>

                {/* Platform Selector */}
                <div className="space-y-2">
                  <Label className="text-white font-semibold">Affiliate Netwerk</Label>
                  <Select value={affiliatePlatform} onValueChange={(value) => setAffiliatePlatform(value as 'bolcom' | 'custom' | 'none')}>
                    <SelectTrigger className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">Geen affiliate producten</SelectItem>
                      <SelectItem value="bolcom">üõí Bol.com</SelectItem>
                      <SelectItem value="custom">üîó Losse affiliate links</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* Bol.com Product Selector */}
                {affiliatePlatform === 'bolcom' && (
                  <div className="space-y-3 pt-3 border-t border-zinc-700">
                    <p className="text-sm text-gray-300">
                      Zoek producten op Bol.com en voeg ze toe met automatische affiliate links
                    </p>
                    
                    <BolcomProductSelector
                      projectId={projectId}
                      selectedProducts={selectedProducts}
                      onProductsChange={setSelectedProducts}
                      maxProducts={10}
                    />
                    
                    {/* üé® LINK DISPLAY TYPE SELECTOR */}
                    {selectedProducts.length > 0 && (
                      <div className="space-y-3 pt-3 border-t border-zinc-700">
                        <Label className="text-white font-medium flex items-center gap-2">
                          <Star className="h-4 w-4 text-orange-500" />
                          Hoe wil je de producten tonen?
                        </Label>
                        <Select value={linkDisplayType} onValueChange={(value: any) => setLinkDisplayType(value)}>
                          <SelectTrigger className="bg-zinc-800 border-zinc-700 text-white">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="ai-mix">
                              ü§ñ Laat AI een mix maken ‚≠ê
                            </SelectItem>
                            <SelectItem value="inline">
                              üîó Natuurlijke links in tekst
                            </SelectItem>
                            <SelectItem value="product-box">
                              üì¶ Product Boxes (huidige stijl)
                            </SelectItem>
                            <SelectItem value="cta-box">
                              ‚ú® CTA Boxes (premium met afbeelding)
                            </SelectItem>
                            <SelectItem value="button">
                              üéØ Call-to-Action Knoppen
                            </SelectItem>
                          </SelectContent>
                        </Select>
                        
                        {/* Preview uitleg per type */}
                        <div className="bg-zinc-800/50 p-3 rounded-lg text-xs text-gray-400">
                          {linkDisplayType === 'ai-mix' && (
                            <p>ü§ñ AI kiest automatisch de beste presentatie per product - combineert verschillende stijlen voor maximale conversie</p>
                          )}
                          {linkDisplayType === 'inline' && (
                            <p>‚úçÔ∏è Producten worden natuurlijk verweven in de tekst met anchor tekst</p>
                          )}
                          {linkDisplayType === 'product-box' && (
                            <p>üì¶ Producten verschijnen als compacte product kaarten</p>
                          )}
                          {linkDisplayType === 'cta-box' && (
                            <p>‚ú® Premium presentatie met grote afbeelding, beschrijving en prijs - perfect voor conversie!</p>
                          )}
                          {linkDisplayType === 'button' && (
                            <p>üéØ Producten worden gepresenteerd met opvallende actie-knoppen</p>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Custom Affiliate Links */}
                {affiliatePlatform === 'custom' && (
                  <div className="space-y-3 pt-3 border-t border-zinc-700">
                    <p className="text-sm text-gray-300">
                      Voeg handmatig affiliate links toe die in de tekst verwerkt worden
                    </p>
                    
                    {customAffiliateLinks.map((link, index) => (
                      <div key={index} className="flex gap-2">
                        <Input
                          value={link.name}
                          onChange={(e) => {
                            const newLinks = [...customAffiliateLinks];
                            newLinks[index].name = e.target.value;
                            setCustomAffiliateLinks(newLinks);
                          }}
                          placeholder="Product naam"
                          className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white"
                        />
                        <Input
                          value={link.url}
                          onChange={(e) => {
                            const newLinks = [...customAffiliateLinks];
                            newLinks[index].url = e.target.value;
                            setCustomAffiliateLinks(newLinks);
                          }}
                          placeholder="Affiliate URL"
                          className="border-zinc-700 focus:border-[#ff6b35] bg-zinc-900 text-white"
                        />
                        {customAffiliateLinks.length > 1 && (
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => {
                              setCustomAffiliateLinks(customAffiliateLinks.filter((_, i) => i !== index));
                            }}
                            className="text-red-400 hover:bg-red-900/20"
                          >
                            <X className="w-4 h-4" />
                          </Button>
                        )}
                      </div>
                    ))}
                    
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setCustomAffiliateLinks([...customAffiliateLinks, { name: '', url: '' }])}
                      className="border-zinc-700 text-gray-300 hover:bg-zinc-800"
                    >
                      <Plus className="w-4 h-4 mr-2" />
                      Link toevoegen
                    </Button>

                    {/* Display Type for Custom Links */}
                    {customAffiliateLinks.some(link => link.name && link.url) && (
                      <div className="space-y-3 pt-3 border-t border-zinc-700">
                        <Label className="text-white font-medium flex items-center gap-2">
                          <Star className="h-4 w-4 text-orange-500" />
                          Hoe wil je de links tonen?
                        </Label>
                        <Select value={linkDisplayType} onValueChange={(value: any) => setLinkDisplayType(value)}>
                          <SelectTrigger className="bg-zinc-800 border-zinc-700 text-white">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="inline">
                              üîó Natuurlijke links in tekst
                            </SelectItem>
                            <SelectItem value="button">
                              üéØ Call-to-Action Knoppen
                            </SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* STEP 4: OUTLINE EDITOR */}
            {currentStep === 4 && (
              <div className="space-y-6">
                <div className="space-y-2">
                  <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                    <ListOrdered className="w-5 h-5 text-[#ff6b35]" />
                    Content Outline (Optioneel)
                  </h3>
                  <p className="text-sm text-gray-300">
                    Genereer en bewerk de structuur van je content voordat je begint met schrijven. Je kunt deze stap ook overslaan.
                  </p>
                </div>

                {outline.length === 0 ? (
                  <div className="text-center py-12 space-y-4 border-2 border-dashed border-zinc-700 rounded-lg">
                    <ListOrdered className="w-16 h-16 text-gray-600 mx-auto" />
                    <div>
                      <h3 className="text-lg font-semibold text-white">Geen outline gegenereerd</h3>
                      <p className="text-sm text-gray-400 mt-1">
                        Genereer een gestructureerde outline voor je content of sla deze stap over
                      </p>
                    </div>
                    <Button
                      onClick={generateOutline}
                      disabled={outlineLoading || !topic.trim()}
                      className="bg-[#ff6b35] hover:bg-[#ff5722] text-white"
                    >
                      {outlineLoading ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Genereren...
                        </>
                      ) : (
                        <>
                          <Sparkles className="w-4 h-4 mr-2" />
                          Genereer Outline
                        </>
                      )}
                    </Button>
                  </div>
                ) : (
                  <>
                    {/* Outline Items */}
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                      {outline.map((item, itemIndex) => (
                        <div key={item.id} className="p-4 bg-zinc-800 rounded-lg border border-zinc-700 space-y-3">
                          <div className="flex items-start gap-2">
                            {/* Move buttons */}
                            <div className="flex flex-col gap-1">
                              <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => moveOutlineSectionUp(item.id)}
                                disabled={itemIndex === 0}
                                className="h-7 w-7 text-gray-400 hover:text-white hover:bg-zinc-700"
                              >
                                <ChevronUp className="w-4 h-4" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => moveOutlineSectionDown(item.id)}
                                disabled={itemIndex === outline.length - 1}
                                className="h-7 w-7 text-gray-400 hover:text-white hover:bg-zinc-700"
                              >
                                <ChevronDown className="w-4 h-4" />
                              </Button>
                            </div>

                            {/* Content */}
                            <div className="flex-1 space-y-2">
                              <div className="flex items-center gap-2">
                                <Badge variant="outline" className="border-[#ff6b35] text-[#ff6b35]">
                                  H2
                                </Badge>
                                <Input
                                  value={item.heading}
                                  onChange={(e) => updateOutlineHeading(item.id, e.target.value)}
                                  placeholder="Hoofd sectie titel"
                                  className="bg-zinc-900 border-zinc-600 text-white font-medium"
                                />
                              </div>

                              {/* Subheadings */}
                              {item.subheadings.length > 0 && (
                                <div className="ml-4 space-y-2">
                                  {item.subheadings.map((subheading, subIndex) => (
                                    <div key={subIndex} className="flex items-center gap-2">
                                      <Badge variant="outline" className="border-gray-500 text-gray-400 text-xs">
                                        H3
                                      </Badge>
                                      <Input
                                        value={subheading}
                                        onChange={(e) => updateSubheading(item.id, subIndex, e.target.value)}
                                        placeholder="Sub sectie"
                                        className="bg-zinc-900 border-zinc-600 text-white text-sm"
                                      />
                                      {item.subheadings.length > 1 && (
                                        <Button
                                          variant="ghost"
                                          size="icon"
                                          onClick={() => removeSubheading(item.id, subIndex)}
                                          className="h-8 w-8 text-red-400 hover:text-red-300 hover:bg-red-900/20"
                                        >
                                          <X className="w-4 h-4" />
                                        </Button>
                                      )}
                                    </div>
                                  ))}
                                  <Button
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => addSubheading(item.id)}
                                    className="text-gray-400 hover:text-white text-xs h-7"
                                  >
                                    <Plus className="w-3 h-3 mr-1" />
                                    Sub-sectie toevoegen
                                  </Button>
                                </div>
                              )}
                            </div>

                            {/* Delete button */}
                            <Button
                              variant="ghost"
                              size="icon"
                              onClick={() => removeOutlineSection(item.id)}
                              className="text-red-400 hover:text-red-300 hover:bg-red-900/20"
                            >
                              <X className="w-4 h-4" />
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* Action Buttons */}
                    <div className="flex flex-wrap gap-2 pt-2">
                      <Button
                        onClick={addOutlineSection}
                        variant="outline"
                        size="sm"
                        className="border-zinc-700 text-gray-300 hover:bg-zinc-800"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Sectie toevoegen
                      </Button>
                      <Button
                        onClick={generateOutline}
                        disabled={outlineLoading}
                        variant="outline"
                        size="sm"
                        className="border-[#ff6b35] text-[#ff6b35] hover:bg-[#ff6b35]/10"
                      >
                        {outlineLoading ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Regenereren...
                          </>
                        ) : (
                          <>
                            <Sparkles className="w-4 h-4 mr-2" />
                            Opnieuw genereren
                          </>
                        )}
                      </Button>
                      <Button
                        onClick={() => setOutline([])}
                        variant="outline"
                        size="sm"
                        className="border-red-700 text-red-400 hover:bg-red-900/20"
                      >
                        <X className="w-4 h-4 mr-2" />
                        Wissen
                      </Button>
                    </div>
                  </>
                )}
              </div>
            )}

            {/* STEP 5: REVIEW & GENEREREN */}
            {currentStep === 5 && (
              <div className="space-y-6">
                <div className="space-y-2">
                  <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                    <Check className="w-5 h-5 text-green-500" />
                    Overzicht & Genereren
                  </h3>
                  <p className="text-sm text-gray-300">
                    Controleer je instellingen en genereer de content
                  </p>
                </div>

                {/* Summary Cards */}
                <div className="space-y-3">
                  {/* Basic Info */}
                  <div className="p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                    <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                      <Target className="w-4 h-4 text-[#ff6b35]" />
                      Basis Instellingen
                    </h4>
                    <div className="space-y-1 text-sm text-gray-300">
                      <p><span className="text-gray-400">Onderwerp:</span> {topic || 'Niet ingevuld'}</p>
                      <p><span className="text-gray-400">Keywords:</span> {keywords || 'Geen'}</p>
                      <p><span className="text-gray-400">Taal:</span> {language === 'nl' ? 'üá≥üá± Nederlands' : 'üá¨üáß Engels'}</p>
                      <p><span className="text-gray-400">Toon:</span> {tone}</p>
                      {projectId && <p><span className="text-gray-400">Project:</span> Gekoppeld</p>}
                    </div>
                  </div>

                  {/* Content Options */}
                  <div className="p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                    <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                      <Settings2 className="w-4 h-4 text-[#ff6b35]" />
                      Content Opties
                    </h4>
                    <div className="space-y-1 text-sm text-gray-300">
                      <p><span className="text-gray-400">Woordaantal:</span> {wordCount} woorden</p>
                      <p><span className="text-gray-400">SEO:</span> {seoOptimized ? '‚úÖ Aan' : '‚ùå Uit'}</p>
                      <p><span className="text-gray-400">Afbeeldingen:</span> {includeImage ? '‚úÖ Aan' : '‚ùå Uit'}</p>
                      <p><span className="text-gray-400">FAQ:</span> {includeFAQ ? '‚úÖ Aan' : '‚ùå Uit'}</p>
                      <p><span className="text-gray-400">YouTube Video:</span> {includeYouTube ? '‚úÖ Aan' : '‚ùå Uit'}</p>
                      <p><span className="text-gray-400">Featured Image:</span> {generateFeaturedImage ? '‚úÖ Aan' : '‚ùå Uit'}</p>
                    </div>
                  </div>

                  {/* Affiliate */}
                  {(affiliatePlatform !== 'none') && (
                    <div className="p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                      <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                        <ShoppingBag className="w-4 h-4 text-[#ff6b35]" />
                        Affiliate Producten
                      </h4>
                      <div className="space-y-1 text-sm text-gray-300">
                        <p><span className="text-gray-400">Platform:</span> {
                          affiliatePlatform === 'bolcom' ? 'üõí Bol.com' : 
                          affiliatePlatform === 'custom' ? 'üîó Losse links' : 
                          'Geen'
                        }</p>
                        {affiliatePlatform === 'bolcom' && (
                          <p><span className="text-gray-400">Producten:</span> {selectedProducts.length} geselecteerd</p>
                        )}
                        {affiliatePlatform === 'custom' && (
                          <p><span className="text-gray-400">Links:</span> {customAffiliateLinks.filter(l => l.name && l.url).length} toegevoegd</p>
                        )}
                        <p><span className="text-gray-400">Weergave:</span> {
                          linkDisplayType === 'ai-mix' ? 'ü§ñ AI Mix' :
                          linkDisplayType === 'inline' ? 'üîó Inline links' :
                          linkDisplayType === 'product-box' ? 'üì¶ Product boxes' :
                          linkDisplayType === 'cta-box' ? '‚ú® CTA boxes' :
                          'üéØ Knoppen'
                        }</p>
                      </div>
                    </div>
                  )}

                  {/* Outline */}
                  {outline.length > 0 && (
                    <div className="p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                      <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                        <ListOrdered className="w-4 h-4 text-[#ff6b35]" />
                        Content Outline
                      </h4>
                      <div className="space-y-1 text-sm text-gray-300">
                        <p><span className="text-gray-400">Secties:</span> {outline.length} hoofdsecties</p>
                        <p className="text-xs text-gray-400">De AI zal deze structuur volgen bij het schrijven</p>
                      </div>
                    </div>
                  )}
                </div>

                {/* Generate Button */}
                <div className="pt-4 border-t border-zinc-700">
                  <Button
                    onClick={generateContent} 
                    disabled={loading || !topic.trim()}
                    className="w-full bg-gradient-to-r from-[#ff6b35] to-[#ff8c42] hover:from-[#ff5722] hover:to-[#ff7033] text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
                    size="lg"
                  >
                    {loading ? (
                      <>
                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                        Content genereren...
                      </>
                    ) : (
                      <>
                        <Sparkles className="w-5 h-5 mr-2" />
                        Genereer Content{outline.length > 0 ? ' met Outline' : ''} ‚Ä¢ 50 Credits
                      </>
                    )}
                  </Button>
                  <p className="text-xs text-gray-400 text-center mt-2">
                    Dit kost 50 credits ‚Ä¢ Geschatte tijd: 2-3 minuten
                  </p>
                </div>
              </div>
            )}

            {/* Navigation Buttons */}
            <div className="flex justify-between items-center pt-6 border-t border-zinc-700">
              <Button
                variant="outline"
                onClick={goToPrevStep}
                disabled={currentStep === 1 || loading}
                className="border-zinc-700 text-gray-300 hover:bg-zinc-800"
              >
                <ChevronLeft className="w-4 h-4 mr-2" />
                Vorige
              </Button>

              <div className="text-sm text-gray-400">
                Stap {currentStep} van {totalSteps}
              </div>

              {currentStep < totalSteps ? (
                <Button
                  onClick={goToNextStep}
                  disabled={loading}
                  className="bg-[#ff6b35] hover:bg-[#ff5722] text-white"
                >
                  Volgende
                  <ChevronRight className="w-4 h-4 ml-2" />
                </Button>
              ) : (
                <div className="w-24" /> // Spacer to keep layout balanced
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}