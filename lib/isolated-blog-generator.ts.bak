
/**
 * Isolated Blog Generator
 * Volledig onafhankelijk systeem voor SEO blog generatie
 */

import { chatCompletion } from './aiml-api';
import { MODEL_CATEGORIES } from './smart-model-router';

export interface BlogGenerationOptions {
  topic: string;
  keywords?: string[];
  length?: number;
  tone?: 'professional' | 'casual' | 'friendly';
  includeSEO?: boolean;
  includeImages?: boolean;
  targetAudience?: string;
  projectContext?: {
    name: string;
    url?: string;
    description?: string;
    targetKeywords?: string[];
  };
}

export interface BlogGenerationResult {
  title: string;
  content: string;
  metaDescription: string;
  keywords: string[];
  readingTime: number;
  seoScore: number;
  suggestions: string[];
  research?: string[];
}

/**
 * Genereer een SEO-geoptimaliseerde blog
 * Deze functie is volledig geÃ¯soleerd en kan niet andere tools beÃ¯nvloeden
 */
export async function generateSEOBlog(
  options: BlogGenerationOptions,
  onProgress?: (step: string, progress: number) => void
): Promise<BlogGenerationResult> {
  
  try {
    onProgress?.('ðŸ” Web research starten...', 10);
    
    // STAP 1: Web Research (ALTIJD met web search model)
    const researchPrompt = `
Je bent een expert SEO researcher. Zoek actuele informatie over: ${options.topic}

${options.keywords ? `Focus op deze keywords: ${options.keywords.join(', ')}` : ''}
${options.projectContext ? `Context: ${options.projectContext.description}` : ''}

Geef een uitgebreid overzicht met:
1. Actuele trends en statistieken
2. Veelgestelde vragen
3. Belangrijke feiten
4. Relevante bronnen
5. Gerelateerde onderwerpen

Formaat: Gestructureerd overzicht in het Nederlands
`;

    const researchResponse = await chatCompletion(
      [{ role: 'user', content: researchPrompt }],
      {
        model: MODEL_CATEGORIES.WEB_SEARCH.primary, // gpt-4o-search-preview
        temperature: 0.3,
        max_tokens: 4000
      }
    );
    
    const research = researchResponse.choices[0]?.message?.content || '';
    onProgress?.('âœ… Research voltooid', 40);
    
    // STAP 2: Blog structuur maken
    onProgress?.('ðŸ“ Blog structuur maken...', 50);
    
    const structurePrompt = `
Op basis van deze research, maak een gedetailleerde blog structuur:

RESEARCH:
${research}

TOPIC: ${options.topic}
LENGTE: ${options.length || 1000} woorden
TOON: ${options.tone || 'professional'}
${options.targetAudience ? `DOELGROEP: ${options.targetAudience}` : ''}

Maak een structuur met:
- Pakkende titel (met keyword)
- Inleiding
- 5-7 secties met H2 headers
- Conclusie
- Meta description (155 karakters)

Geef alleen de structuur in JSON formaat:
{
  "title": "...",
  "metaDescription": "...",
  "sections": [
    {"heading": "...", "keyPoints": ["...", "..."]}
  ]
}
`;
    
    const structureResponse = await chatCompletion(
      [{ role: 'user', content: structurePrompt }],
      {
        model: MODEL_CATEGORIES.SEO_WRITING.primary, // claude-3-7-sonnet
        temperature: 0.7,
        max_tokens: 2000
      }
    );
    
    const structureText = structureResponse.choices[0]?.message?.content || '{}';
    let structure;
    try {
      // Extract JSON from markdown if needed
      const jsonMatch = structureText.match(/\{[\s\S]*\}/);
      structure = JSON.parse(jsonMatch ? jsonMatch[0] : structureText);
    } catch (e) {
      // Fallback structure
      structure = {
        title: options.topic,
        metaDescription: `Alles over ${options.topic}`,
        sections: [
          { heading: 'Inleiding', keyPoints: [] },
          { heading: 'Wat is belangrijk?', keyPoints: [] },
          { heading: 'Conclusie', keyPoints: [] }
        ]
      };
    }
    
    onProgress?.('âœ… Structuur klaar', 60);
    
    // STAP 3: Volledige blog schrijven
    onProgress?.('âœï¸ Blog schrijven...', 70);
    
    const writingPrompt = `
Je bent een expert SEO content writer. Schrijf een volledige blog artikel.

STRUCTUUR:
${JSON.stringify(structure, null, 2)}

RESEARCH:
${research}

EISEN:
- Schrijf in het Nederlands
- Gebruik natuurlijke, vloeiende taal
- ${options.length || 1000} woorden
- Toon: ${options.tone || 'professional'}
- SEO-geoptimaliseerd (maar natuurlijk)
- Gebruik H2 en H3 headers
- Voeg relevante voorbeelden toe
- Sluit af met een call-to-action

${options.projectContext?.url ? `Vermeld waar relevant: ${options.projectContext.url}` : ''}

Formaat: Markdown met headers, paragrafen, en lijsten.
`;
    
    const contentResponse = await chatCompletion(
      [{ role: 'user', content: writingPrompt }],
      {
        model: MODEL_CATEGORIES.SEO_WRITING.primary, // claude-3-7-sonnet
        temperature: 0.8,
        max_tokens: 8000
      }
    );
    
    const content = contentResponse.choices[0]?.message?.content || '';
    onProgress?.('âœ… Blog geschreven', 90);
    
    // STAP 4: SEO analyse
    onProgress?.('ðŸ“Š SEO analyse...', 95);
    
    const wordCount = content.split(/\s+/).length;
    const readingTime = Math.ceil(wordCount / 200); // 200 woorden per minuut
    
    // Simpele SEO score
    let seoScore = 50;
    if (content.includes(options.topic)) seoScore += 10;
    if (wordCount >= (options.length || 1000)) seoScore += 10;
    if (content.match(/##/g)?.length >= 3) seoScore += 10;
    if (structure.metaDescription.length <= 160) seoScore += 10;
    if (content.length > 500) seoScore += 10;
    
    onProgress?.('âœ… Klaar!', 100);
    
    return {
      title: structure.title,
      content,
      metaDescription: structure.metaDescription,
      keywords: options.keywords || [options.topic],
      readingTime,
      seoScore: Math.min(seoScore, 100),
      suggestions: [
        seoScore < 80 ? 'Overweeg om meer keywords toe te voegen' : '',
        readingTime < 3 ? 'Blog is mogelijk te kort voor goede SEO' : '',
        content.match(/##/g)?.length < 3 ? 'Voeg meer subheaders toe' : ''
      ].filter(Boolean),
      research: [research]
    };
    
  } catch (error) {
    console.error('Blog generation error:', error);
    throw new Error(`Blog generatie mislukt: ${error.message}`);
  }
}
