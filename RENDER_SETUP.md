# Writgo AI - Render Deployment Guide

This guide provides comprehensive instructions for deploying the Writgo AI application to Render.

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Environment Variables](#environment-variables)
3. [Database Setup](#database-setup)
4. [Deployment Steps](#deployment-steps)
5. [Post-Deployment Verification](#post-deployment-verification)
6. [Troubleshooting](#troubleshooting)
7. [Maintenance](#maintenance)

## Prerequisites

Before deploying to Render, ensure you have:

- A Render account (https://render.com)
- GitHub repository access
- PostgreSQL database credentials (Render provides this)
- All required API keys and credentials (see Environment Variables section)

## Environment Variables

### Required Environment Variables

The following environment variables MUST be configured in Render:

#### Core Application Settings

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `NODE_ENV` | Node environment | `production` (auto-set) |
| `DATABASE_URL` | PostgreSQL connection string | Provided by Render database |
| `NEXTAUTH_URL` | Application URL | `https://writgoai.nl` |
| `NEXTAUTH_SECRET` | NextAuth JWT secret | Auto-generated by Render |

#### AIML API (Required for AI Features)

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `AIML_API_KEY` | AIML API key for Claude AI | https://aimlapi.com/ |
| `AIML_API_BASE_URL` | AIML API base URL | `https://api.aimlapi.com/v1` |
| `AIML_API_URL` | AIML API URL (alias) | `https://api.aimlapi.com/v1` |

#### AWS S3 (Required for File Uploads)

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `AWS_BUCKET_NAME` | S3 bucket name | AWS Console |
| `AWS_ACCESS_KEY_ID` | AWS access key | AWS IAM |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key | AWS IAM |
| `AWS_REGION` | AWS region | `eu-west-1` |
| `AWS_FOLDER_PREFIX` | S3 folder prefix | `uploads/` |

#### Stripe (Required for Payments)

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `STRIPE_SECRET_KEY` | Stripe secret key | Stripe Dashboard |
| `STRIPE_STARTER_PRICE_ID` | Starter plan price ID | Stripe Dashboard |
| `STRIPE_PRO_PRICE_ID` | Pro plan price ID | Stripe Dashboard |
| `STRIPE_ENTERPRISE_PRICE_ID` | Enterprise plan price ID | Stripe Dashboard |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook secret | Stripe Dashboard |

#### Email Configuration (Required for Notifications)

| Variable | Description | Example |
|----------|-------------|---------|
| `SMTP_HOST` | SMTP server host | `smtp.gmail.com` |
| `SMTP_PORT` | SMTP server port | `587` |
| `SMTP_USER` | SMTP username | Your email |
| `SMTP_PASS` | SMTP password | App password |
| `EMAIL_USER` | Sender email address | Your email |

#### Google Search Console (Optional)

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `GOOGLE_SEARCH_CONSOLE_CLIENT_ID` | OAuth client ID | Google Cloud Console |
| `GOOGLE_SEARCH_CONSOLE_CLIENT_SECRET` | OAuth client secret | Google Cloud Console |

#### Optional API Keys

These are optional but enable additional features:

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `OPENAI_API_KEY` | OpenAI API key | https://platform.openai.com/ |
| `PIXABAY_API_KEY` | Pixabay API key | https://pixabay.com/api/docs/ |
| `ELEVENLABS_API_KEY` | ElevenLabs API key | https://elevenlabs.io/ |
| `RUNWAY_API_KEY` | Runway API key | https://runwayml.com/ |
| `LUMA_API_KEY` | Luma AI API key | https://lumalabs.ai/ |
| `VADOO_API_KEY` | Vadoo AI API key | https://vadoo.tv/ |
| `BOLCOM_CLIENT_ID` | Bol.com affiliate client ID | https://partnerprogramma.bol.com/ |
| `BOLCOM_CLIENT_SECRET` | Bol.com affiliate secret | https://partnerprogramma.bol.com/ |
| `DATAFORSEO_USERNAME` | DataForSEO username | https://dataforseo.com/ |
| `DATAFORSEO_PASSWORD` | DataForSEO password | https://dataforseo.com/ |
| `ABACUSAI_API_KEY` | Abacus AI API key | https://abacus.ai/ |

#### Auto-Generated Variables

These are automatically generated by Render:

- `JWT_SECRET` - JWT signing secret
- `CRON_SECRET` - Cron job authentication secret
- `NEXT_PUBLIC_APP_URL` - Public application URL

## Database Setup

### Using Render PostgreSQL

1. **Create Database in Render:**
   - The `render.yaml` file already configures a PostgreSQL database
   - Database name: `writgoai_production`
   - Region: Frankfurt (same as web service for low latency)
   - Version: PostgreSQL 15

2. **Database Connection:**
   - Render automatically provides the `DATABASE_URL` to the web service
   - Connection string format: `postgresql://user:password@host:port/database`

3. **Migrations:**
   - Migrations run automatically on startup via `start.sh`
   - The script retries up to 3 times if migrations fail
   - Manual migration: `npx prisma migrate deploy`

### Using External PostgreSQL (e.g., Supabase)

If using an external database:

1. Set up your PostgreSQL database
2. Get the connection string
3. In Render dashboard, remove the database service from `render.yaml`
4. Add `DATABASE_URL` as a secret environment variable
5. Ensure the connection string uses SSL: `?sslmode=require`

## Deployment Steps

### Method 1: Using render.yaml (Recommended)

1. **Connect Repository to Render:**
   ```
   - Go to Render Dashboard
   - Click "New" → "Blueprint"
   - Connect your GitHub repository
   - Select the repository: Mikeyy1405/Writgoai.nl
   - Render will detect render.yaml automatically
   ```

2. **Configure Environment Variables:**
   ```
   - Render will prompt for all environment variables marked with sync: false
   - Fill in all required variables (see Environment Variables section)
   - Click "Apply" to create services
   ```

3. **Wait for Deployment:**
   ```
   - Database will be created first
   - Web service will build using Docker
   - Build takes 5-10 minutes on first deploy
   - Subsequent deploys are faster due to caching
   ```

### Method 2: Manual Setup

1. **Create Database:**
   ```
   - Dashboard → New → PostgreSQL
   - Name: writgoai-db
   - Database: writgoai_production
   - Region: Frankfurt
   - Plan: Starter or higher
   ```

2. **Create Web Service:**
   ```
   - Dashboard → New → Web Service
   - Connect repository
   - Environment: Docker
   - Region: Frankfurt
   - Branch: main
   - Dockerfile path: ./Dockerfile
   - Health Check Path: /api/health
   ```

3. **Configure Environment Variables:**
   ```
   - Add all required environment variables
   - Link DATABASE_URL from database service
   - Generate secrets for NEXTAUTH_SECRET, JWT_SECRET, CRON_SECRET
   ```

4. **Deploy:**
   ```
   - Click "Create Web Service"
   - Monitor build logs
   ```

## Post-Deployment Verification

### 1. Check Health Endpoint

```bash
curl https://writgoai.nl/api/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "database": "connected",
  "service": "writgoai"
}
```

### 2. Verify Database Migrations

Check Render logs for:
```
✓ Database migrations completed successfully
✓ Starting Next.js Production Server
```

### 3. Test Key Features

- [ ] User authentication (login/register)
- [ ] AI content generation
- [ ] File uploads to S3
- [ ] Payment processing with Stripe
- [ ] Email notifications
- [ ] Database operations (CRUD)

### 4. Monitor Logs

```bash
# In Render Dashboard
- Go to your web service
- Click "Logs" tab
- Monitor for errors or warnings
```

### 5. Check Performance

- Response times should be < 500ms for most requests
- Health check should respond in < 100ms
- Database queries should be fast (< 50ms)

## Troubleshooting

### Build Failures

**Problem:** Docker build fails during dependency installation

**Solution:**
```bash
# Check if node_modules are excluded in .dockerignore
# Verify package.json and package-lock.json exist
# Check Render build logs for specific error
```

**Problem:** Prisma Client generation fails

**Solution:**
```bash
# Ensure DATABASE_URL is set during build
# Check prisma/schema.prisma for syntax errors
# Verify binaryTargets include linux-musl-openssl-3.0.x
```

### Runtime Failures

**Problem:** Application crashes on startup

**Solution:**
```bash
# Check Render logs for error messages
# Verify all required environment variables are set
# Ensure DATABASE_URL is correct
# Check database connectivity
```

**Problem:** Database migrations fail

**Solution:**
```bash
# Check database credentials
# Verify database is accessible
# Check migration files in prisma/migrations
# Try manual migration: npx prisma migrate deploy
```

**Problem:** Health check fails

**Solution:**
```bash
# Check if app is listening on PORT environment variable
# Verify database connection
# Check /api/health route exists
# Review health check logs
```

### Performance Issues

**Problem:** Slow response times

**Solution:**
```bash
# Upgrade to higher Render plan
# Optimize database queries
# Add database indexes
# Enable Redis caching
# Use CDN for static assets
```

**Problem:** Out of memory

**Solution:**
```bash
# Upgrade to plan with more RAM
# Optimize image processing
# Review memory leaks in code
# Increase Node.js heap size if needed
```

### Connection Issues

**Problem:** Cannot connect to database

**Solution:**
```bash
# Verify DATABASE_URL is correct
# Check database is running
# Verify network connectivity
# Check IP allowlist settings
# Ensure SSL connection is enabled
```

**Problem:** External API timeouts

**Solution:**
```bash
# Verify API keys are correct
# Check API rate limits
# Verify network egress from Render
# Add timeout and retry logic
```

## Maintenance

### Regular Tasks

1. **Monitor Logs:**
   - Check logs daily for errors
   - Set up log alerts in Render
   - Monitor error rates

2. **Database Backups:**
   - Render auto-backups daily on paid plans
   - Export manual backups monthly
   - Test restore procedures

3. **Update Dependencies:**
   ```bash
   # Update npm packages
   npm update
   npm audit fix
   
   # Update Prisma
   npx prisma migrate dev
   ```

4. **Security Updates:**
   - Update Node.js version regularly
   - Patch security vulnerabilities
   - Rotate API keys and secrets
   - Review access logs

### Scaling

**Vertical Scaling (More Resources):**
```
- Render Dashboard → Service → Settings
- Change to higher plan (more CPU/RAM)
- Apply changes (may require restart)
```

**Horizontal Scaling (More Instances):**
```
- Render Dashboard → Service → Settings
- Increase instance count
- Enable autoscaling based on CPU/memory
```

### Rollback Procedure

If deployment fails:
```
1. Go to Render Dashboard
2. Select web service
3. Go to "Deploys" tab
4. Find last successful deploy
5. Click "Rollback" button
6. Confirm rollback
```

### Cost Optimization

1. **Use Free Tier for Database:**
   - Free tier includes basic PostgreSQL
   - Good for development/testing
   - Upgrade for production

2. **Optimize Docker Image:**
   - Multi-stage build reduces image size
   - Alpine Linux saves resources
   - Cache layers speed up builds

3. **Monitor Usage:**
   - Track bandwidth usage
   - Monitor database storage
   - Review build minutes
   - Check instance hours

## Support

### Getting Help

1. **Render Support:**
   - Documentation: https://render.com/docs
   - Community Forum: https://community.render.com
   - Support Email: support@render.com

2. **Application Issues:**
   - Check logs first
   - Review this documentation
   - Check GitHub issues
   - Contact development team

### Useful Commands

```bash
# Check Prisma schema
npx prisma validate

# View database schema
npx prisma db pull

# Generate Prisma Client
npx prisma generate

# Run migrations
npx prisma migrate deploy

# View database data
npx prisma studio

# Check Node.js version
node --version

# Check npm version
npm --version

# Test database connection
npx prisma db execute --stdin <<< "SELECT 1;"
```

## Additional Resources

- [Next.js Documentation](https://nextjs.org/docs)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Render Documentation](https://render.com/docs)
- [Docker Documentation](https://docs.docker.com/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

---

**Last Updated:** November 26, 2024
**Version:** 1.0.0
