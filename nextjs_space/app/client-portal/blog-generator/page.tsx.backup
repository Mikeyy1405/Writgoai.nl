
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  FileText, 
  Loader2, 
  Sparkles,
  Settings2,
  Target,
  PenTool,
  BarChart3,
  ArrowLeft,
  ShoppingBag,
  Star,
  List,
  Plus,
  X
} from 'lucide-react';
import { toast } from 'sonner';
import BlogCanvas from '@/components/blog-canvas';
import Link from 'next/link';

// WritgoAI Brand Colors
const BRAND_COLORS = {
  black: '#000000',
  orange: '#ff6b35',
  white: '#FFFFFF',
  cardBg: '#0a0a0a',
  cardBorder: '#1a1a1a',
};

interface Product {
  name: string;
  url: string;
  price?: string;
  rating?: string;
  description?: string;
}

export default function BlogGenerator() {
  const { data: session } = useSession() || {};
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState(0);
  
  // Template selection
  const [contentType, setContentType] = useState<'blog' | 'product-review' | 'top-list'>('blog');
  
  // Form state - Blog
  const [topic, setTopic] = useState('');
  const [keywords, setKeywords] = useState('');
  const [wordCount, setWordCount] = useState('1500');
  const [tone, setTone] = useState('professional');
  const [language, setLanguage] = useState('nl');
  const [seoOptimized, setSeoOptimized] = useState(true);
  const [includeImage, setIncludeImage] = useState(true);
  const [imageStyle, setImageStyle] = useState('realistic');
  const [projectId, setProjectId] = useState<string>('');
  const [sitemapUrl, setSitemapUrl] = useState('');
  
  // Form state - Product Review
  const [category, setCategory] = useState('');
  const [reviewType, setReviewType] = useState<'single' | 'comparison'>('single');
  const [targetAudience, setTargetAudience] = useState('');
  const [products, setProducts] = useState<Product[]>([{ name: '', url: '' }]);
  const [additionalContext, setAdditionalContext] = useState('');
  
  // Projects
  const [projects, setProjects] = useState<any[]>([]);
  const [loadingProjects, setLoadingProjects] = useState(true);
  
  // Generated content
  const [generatedArticle, setGeneratedArticle] = useState('');
  const [articleTitle, setArticleTitle] = useState('');
  
  // Status updates
  const [statusMessage, setStatusMessage] = useState('');

  // Check authentication
  useEffect(() => {
    if (!session) {
      router.push('/client-login');
    } else {
      loadProjects();
    }
  }, [session, router]);

  // Auto-fill sitemap URL when project is selected
  useEffect(() => {
    if (projectId && projectId !== 'none') {
      const selectedProject = projects.find(p => p.id === projectId);
      if (selectedProject?.websiteUrl) {
        console.log('üîó Auto-filling sitemap URL from project:', selectedProject.websiteUrl);
        setSitemapUrl(selectedProject.websiteUrl);
      }
    } else {
      // Clear sitemap URL when no project is selected
      setSitemapUrl('');
    }
  }, [projectId, projects]);

  // Load projects
  const loadProjects = async () => {
    try {
      const response = await fetch('/api/client/ai-settings');
      if (response.ok) {
        const data = await response.json();
        setProjects([
          { id: '', name: 'Geen project' },
          ...data.projects
        ]);
      }
    } catch (error) {
      console.error('Error loading projects:', error);
    } finally {
      setLoadingProjects(false);
    }
  };

  // Product management functions
  const addProduct = () => {
    setProducts([...products, { name: '', url: '' }]);
  };

  const removeProduct = (index: number) => {
    if (products.length > 1) {
      setProducts(products.filter((_, i) => i !== index));
    }
  };

  const updateProduct = (index: number, field: keyof Product, value: string) => {
    const updated = [...products];
    updated[index] = { ...updated[index], [field]: value };
    setProducts(updated);
  };

  const scrapeProduct = async (index: number) => {
    const product = products[index];
    if (!product.url) {
      toast.error('Voer eerst een product URL in');
      return;
    }

    toast.loading('Product info ophalen...', { id: 'scrape' });

    try {
      const response = await fetch('/api/ai-agent/scrape-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: product.url }),
      });

      if (!response.ok) throw new Error('Scraping failed');

      const data = await response.json();
      updateProduct(index, 'name', data.name || product.name);
      updateProduct(index, 'price', data.price || product.price || '');
      updateProduct(index, 'rating', data.rating || product.rating || '');
      updateProduct(index, 'description', data.description || product.description || '');

      toast.success('Product info opgehaald!', { id: 'scrape' });
    } catch (error) {
      toast.error('Kon product info niet ophalen', { id: 'scrape' });
    }
  };

  // Generate content
  const generateContent = async () => {
    // Validation
    if (contentType === 'blog' && !topic.trim()) {
      toast.error('Voer een onderwerp in');
      return;
    }

    if ((contentType === 'product-review' || contentType === 'top-list') && !category.trim()) {
      toast.error('Voer een categorie in');
      return;
    }

    if ((contentType === 'product-review' || contentType === 'top-list') && products.some(p => !p.url.trim())) {
      toast.error('Voer alle product URLs in');
      return;
    }

    setLoading(true);
    setProgress(0);
    setStatusMessage('üöÄ Content generatie starten...');

    try {
      let response;
      
      if (contentType === 'blog') {
        response = await fetch('/api/ai-agent/generate-blog', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            topic,
            keywords: keywords.split(',').map(k => k.trim()).filter(Boolean),
            wordCount: parseInt(wordCount),
            tone,
            language,
            seoOptimized,
            includeImage,
            imageStyle,
            projectId: projectId || undefined,
            sitemapUrl: sitemapUrl || undefined,
          }),
        });
      } else {
        // Product review or top list
        response = await fetch('/api/ai-agent/generate-product-review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category,
            reviewType: contentType === 'top-list' ? 'comparison' : reviewType,
            targetAudience,
            tone,
            language,
            products,
            additionalContext,
          }),
        });
      }

      if (!response.ok) {
        throw new Error('Fout bij het genereren van content');
      }

      // Read streaming response
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      if (!reader) {
        throw new Error('Geen response stream');
      }

      while (true) {
        const { done, value } = await reader.read();
        
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';
        
        for (const line of lines) {
          if (!line.trim()) continue;
          
          try {
            const data = JSON.parse(line);
            
            if (data.status === 'error') {
              throw new Error(data.error || 'Fout bij het genereren van content');
            }
            
            if (data.status === 'complete') {
              // Final result
              setArticleTitle(data.title || topic || category);
              setGeneratedArticle(data.content);
              setProgress(100);
              setStatusMessage('‚úÖ Content generatie voltooid!');
              toast.success(`Content succesvol gegenereerd! (${data.creditsUsed} credits gebruikt)`);
            } else if (data.status) {
              // Status update
              setStatusMessage(data.status);
              setProgress(data.progress || 0);
            }
          } catch (parseError) {
            console.error('Error parsing stream:', parseError);
          }
        }
      }
    } catch (error: any) {
      console.error('Error generating content:', error);
      toast.error(error.message || 'Fout bij het genereren van content');
      setStatusMessage('');
    } finally {
      setLoading(false);
      setTimeout(() => {
        setProgress(0);
        setStatusMessage('');
      }, 2000);
    }
  };

  // Reset form
  const reset = () => {
    setTopic('');
    setKeywords('');
    setCategory('');
    setProducts([{ name: '', url: '' }]);
    setAdditionalContext('');
    setGeneratedArticle('');
    setArticleTitle('');
  };

  // Save blog to database
  const saveBlogToDatabase = async (content: string, autoSave: boolean = false) => {
    try {
      // Extract title from HTML
      const titleMatch = content.match(/<h1>(.*?)<\/h1>/);
      const title = titleMatch ? titleMatch[1] : articleTitle;

      // Extract keywords from content
      const keywordsList = keywords.split(',').map(k => k.trim()).filter(Boolean);

      const response = await fetch('/api/client/content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          content,
          keywords: keywordsList,
          metaDescription: `${title.substring(0, 155)}...`,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        if (!autoSave) {
          toast.success('‚úÖ Blog opgeslagen in je Content Bibliotheek!');
          // Clear localStorage
          localStorage.removeItem('blog-draft-content');
          localStorage.removeItem('blog-draft-timestamp');
          localStorage.removeItem('current-blog-content');
          localStorage.removeItem('current-blog-timestamp');
          // Reset and go back
          setTimeout(() => {
            reset();
          }, 1500);
        }
        return data.content;
      } else {
        throw new Error('Kon blog niet opslaan');
      }
    } catch (error: any) {
      console.error('Error saving blog:', error);
      if (!autoSave) {
        toast.error('Fout bij het opslaan van blog');
      }
      return null;
    }
  };

  // Render canvas if article is generated
  if (generatedArticle) {
    return (
      <BlogCanvas
        content={generatedArticle}
        isGenerating={false}
        topic={articleTitle}
        // onSave callback verwijderd - blog wordt al automatisch opgeslagen door backend na generatie
      />
    );
  }

  return (
    <div className="min-h-screen p-4 md:p-8 bg-gradient-to-br from-gray-50 via-white to-orange-50">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <Link href="/client-portal">
            <Button variant="ghost" className="mb-4 text-gray-600 hover:text-gray-900 hover:bg-gray-100">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Terug naar overzicht
            </Button>
          </Link>
          
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 rounded-xl shadow-lg bg-gradient-to-br from-[#ff6b35] to-[#ff8c42]">
              <FileText className="w-7 h-7 text-white" />
            </div>
            <div>
              <h1 className="text-4xl font-bold text-gray-900">
                Content Generator
              </h1>
              <p className="text-lg mt-1 text-gray-600">
                SEO-geoptimaliseerde content met AI
              </p>
            </div>
          </div>
          
          {/* Template Selector */}
          <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
            <button
              onClick={() => setContentType('blog')}
              className={`p-4 rounded-lg border-2 transition-all ${
                contentType === 'blog'
                  ? 'border-[#ff6b35] bg-orange-50 shadow-md'
                  : 'border-gray-200 hover:border-gray-300 bg-white'
              }`}
            >
              <FileText className={`w-6 h-6 mx-auto mb-2 ${
                contentType === 'blog' ? 'text-[#ff6b35]' : 'text-gray-600'
              }`} />
              <h3 className={`font-semibold ${
                contentType === 'blog' ? 'text-[#ff6b35]' : 'text-gray-900'
              }`}>
                Blog
              </h3>
              <p className="text-xs text-gray-600 mt-1">10 credits</p>
            </button>

            <button
              onClick={() => setContentType('product-review')}
              className={`p-4 rounded-lg border-2 transition-all ${
                contentType === 'product-review'
                  ? 'border-[#ff6b35] bg-orange-50 shadow-md'
                  : 'border-gray-200 hover:border-gray-300 bg-white'
              }`}
            >
              <Star className={`w-6 h-6 mx-auto mb-2 ${
                contentType === 'product-review' ? 'text-[#ff6b35]' : 'text-gray-600'
              }`} />
              <h3 className={`font-semibold ${
                contentType === 'product-review' ? 'text-[#ff6b35]' : 'text-gray-900'
              }`}>
                Product Review
              </h3>
              <p className="text-xs text-gray-600 mt-1">15 credits</p>
            </button>

            <button
              onClick={() => setContentType('top-list')}
              className={`p-4 rounded-lg border-2 transition-all ${
                contentType === 'top-list'
                  ? 'border-[#ff6b35] bg-orange-50 shadow-md'
                  : 'border-gray-200 hover:border-gray-300 bg-white'
              }`}
            >
              <List className={`w-6 h-6 mx-auto mb-2 ${
                contentType === 'top-list' ? 'text-[#ff6b35]' : 'text-gray-600'
              }`} />
              <h3 className={`font-semibold ${
                contentType === 'top-list' ? 'text-[#ff6b35]' : 'text-gray-900'
              }`}>
                Top 5/10 Lijst
              </h3>
              <p className="text-xs text-gray-600 mt-1">15 credits</p>
            </button>
          </div>
          
          {/* AI Models Badge */}
          <div className="mt-4 flex flex-wrap gap-2">
            <Badge variant="outline" className="border-[#ff6b35] text-[#ff6b35] bg-orange-50">
              <Sparkles className="w-3 h-3 mr-1" />
              GPT-4o Search (Research)
            </Badge>
            <Badge variant="outline" className="border-blue-500 text-blue-600 bg-blue-50">
              <Sparkles className="w-3 h-3 mr-1" />
              Claude 3.7 Sonnet (Writing)
            </Badge>
          </div>
        </div>

        {/* Progress bar with detailed status */}
        {progress > 0 && (
          <div className="mb-6 rounded-lg p-4 shadow-md bg-white border border-gray-200">
            <Progress value={progress} className="h-3 bg-gray-200">
              <div 
                className="h-full transition-all duration-500 bg-gradient-to-r from-[#ff6b35] to-[#ff8c42]"
                style={{ width: `${progress}%` }}
              />
            </Progress>
            <div className="mt-3 flex items-center justify-between">
              <p className="text-sm font-medium text-gray-700">
                {statusMessage || 'Blog genereren...'}
              </p>
              <Badge variant="outline" className="border-[#ff6b35] text-[#ff6b35] bg-orange-50">
                {progress}%
              </Badge>
            </div>
          </div>
        )}

        <Card className="bg-white border-gray-200 shadow-xl">
          <CardHeader className="border-b border-gray-200">
            <CardTitle className="flex items-center gap-2 text-gray-900">
              <Settings2 className="w-5 h-5 text-[#ff6b35]" />
              Blog Instellingen
            </CardTitle>
            <CardDescription className="text-gray-600">
              Configureer je blog en laat de AI het schrijven
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6 pt-6">
            {/* Topic */}
            <div className="space-y-2">
              <Label htmlFor="topic" className="flex items-center gap-2 text-gray-900 font-semibold">
                <Target className="w-4 h-4 text-[#ff6b35]" />
                Onderwerp *
              </Label>
              <Textarea
                id="topic"
                value={topic}
                onChange={(e) => setTopic(e.target.value)}
                placeholder="Bijvoorbeeld: De toekomst van AI in marketing"
                rows={3}
                className="border-gray-300 focus:border-[#ff6b35] focus:ring-[#ff6b35] bg-white text-gray-900 placeholder:text-gray-600"
              />
            </div>

            {/* Keywords */}
            <div className="space-y-2">
              <Label htmlFor="keywords" className="flex items-center gap-2 text-gray-900 font-semibold">
                <BarChart3 className="w-4 h-4 text-[#ff6b35]" />
                Keywords (optioneel)
              </Label>
              <Input
                id="keywords"
                value={keywords}
                onChange={(e) => setKeywords(e.target.value)}
                placeholder="AI, marketing, automatisering, trends"
                className="border-gray-300 focus:border-[#ff6b35] focus:ring-[#ff6b35] bg-white text-gray-900 placeholder:text-gray-600"
              />
              <p className="text-xs text-gray-600">
                Gescheiden door komma's ‚Ä¢ Deze keywords worden natuurlijk verwerkt in de tekst
              </p>
            </div>

            {/* Sitemap URL voor interne links */}
            <div className="space-y-2">
              <Label htmlFor="sitemapUrl" className="flex items-center gap-2 text-gray-900 font-semibold">
                üîó Website URL (optioneel)
              </Label>
              <Input
                id="sitemapUrl"
                value={sitemapUrl}
                onChange={(e) => setSitemapUrl(e.target.value)}
                placeholder="https://www.jouwwebsite.nl"
                className="border-gray-300 focus:border-[#ff6b35] focus:ring-[#ff6b35] bg-white text-gray-900 placeholder:text-gray-600"
              />
              <p className="text-xs text-gray-600">
                De AI voegt automatisch relevante interne links toe naar pagina's op je website
              </p>
            </div>

            {/* Row: Word count + Tone */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="wordCount" className="text-gray-900 font-semibold">
                  Woordaantal
                </Label>
                <Select value={wordCount} onValueChange={setWordCount}>
                  <SelectTrigger className="border-gray-300 focus:border-[#ff6b35] bg-white text-gray-900">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="500">500 woorden</SelectItem>
                    <SelectItem value="1000">1000 woorden</SelectItem>
                    <SelectItem value="1500">1500 woorden ‚≠ê</SelectItem>
                    <SelectItem value="2000">2000 woorden</SelectItem>
                    <SelectItem value="2500">2500+ woorden</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="tone" className="flex items-center gap-2 text-gray-900 font-semibold">
                  <PenTool className="w-4 h-4 text-[#ff6b35]" />
                  Toon
                </Label>
                <Select value={tone} onValueChange={setTone}>
                  <SelectTrigger className="border-gray-300 focus:border-[#ff6b35] bg-white text-gray-900">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="professional">Professioneel</SelectItem>
                    <SelectItem value="casual">Casual</SelectItem>
                    <SelectItem value="expert">Expert</SelectItem>
                    <SelectItem value="friendly">Vriendelijk</SelectItem>
                    <SelectItem value="formal">Formeel</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Row: Language + Project */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="language" className="text-gray-900 font-semibold">Taal</Label>
                <Select value={language} onValueChange={setLanguage}>
                  <SelectTrigger className="border-gray-300 focus:border-[#ff6b35] bg-white text-gray-900">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="nl">üá≥üá± Nederlands</SelectItem>
                    <SelectItem value="en">üá¨üáß Engels</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="project" className="text-gray-900 font-semibold">
                  Project (optioneel)
                </Label>
                <Select 
                  value={projectId} 
                  onValueChange={setProjectId}
                  disabled={loadingProjects}
                >
                  <SelectTrigger className="border-gray-300 focus:border-[#ff6b35] bg-white text-gray-900">
                    <SelectValue placeholder="Selecteer project" />
                  </SelectTrigger>
                  <SelectContent>
                    {projects.map((project) => (
                      <SelectItem key={project.id || 'none'} value={project.id || 'none'}>
                        {project.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Switches */}
            <div className="space-y-4 pt-4 border-t">
              <div className="flex items-center justify-between p-4 bg-white rounded-lg border border-[#ff6b35]">
                <div className="space-y-0.5">
                  <Label className="text-gray-900 font-semibold">SEO Optimalisatie</Label>
                  <p className="text-sm text-gray-600">
                    Geoptimaliseerd voor zoekmachines
                  </p>
                </div>
                <Switch
                  checked={seoOptimized}
                  onCheckedChange={setSeoOptimized}
                  className="data-[state=checked]:bg-[#ff6b35]"
                />
              </div>

              <div className="space-y-3 p-4 bg-white rounded-lg border border-[#4A90E2]">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label className="text-gray-900 font-semibold">Afbeeldingen toevoegen</Label>
                    <p className="text-sm text-gray-600">
                      Genereer automatisch passende afbeeldingen met AI
                    </p>
                  </div>
                  <Switch
                    checked={includeImage}
                    onCheckedChange={setIncludeImage}
                    className="data-[state=checked]:bg-[#4A90E2]"
                  />
                </div>
                
                {includeImage && (
                  <div className="space-y-2 pt-2 border-t border-gray-300">
                    <Label htmlFor="imageStyle" className="text-white font-semibold text-sm">
                      Afbeeldingsstijl
                    </Label>
                    <Select value={imageStyle} onValueChange={setImageStyle}>
                      <SelectTrigger className="border-gray-300 focus:border-[#ff6b35] bg-white text-gray-900">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="realistic">üé® Realistisch</SelectItem>
                        <SelectItem value="illustration">‚úèÔ∏è Illustratie</SelectItem>
                        <SelectItem value="minimalist">‚ö™ Minimalistisch</SelectItem>
                        <SelectItem value="modern">üåü Modern</SelectItem>
                        <SelectItem value="professional">üíº Professioneel</SelectItem>
                        <SelectItem value="creative">üé≠ Creatief</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                )}
              </div>
            </div>

            {/* Generate button */}
            <Button 
              onClick={generateBlog} 
              disabled={loading || !topic.trim()}
              className="w-full bg-[#ff6b35] hover:bg-[#FFB84D] text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
              size="lg"
            >
              {loading ? (
                <>
                  <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                  Blog genereren...
                </>
              ) : (
                <>
                  <Sparkles className="w-5 h-5 mr-2" />
                  Genereer Blog ‚Ä¢ 10 Credits
                </>
              )}
            </Button>

            {/* Info */}
            <div className="bg-white border border-zinc-800 rounded-lg p-4">
              <p className="text-sm text-gray-700">
                <strong className="text-[#ff6b35]">üí° Tip:</strong> Voor beste resultaten, voer een specifiek onderwerp in en voeg relevante keywords toe. De AI voert automatisch actueel web research uit voordat het blog wordt geschreven.
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
