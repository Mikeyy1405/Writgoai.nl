
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Skeleton } from '@/components/ui/skeleton';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { toast } from 'sonner';
import { 
  RefreshCw, 
  TrendingUp, 
  AlertCircle, 
  CheckCircle2, 
  Sparkles,
  ExternalLink,
  FileText,
  Search,
  Zap,
  Edit3,
  Send,
  Calendar,
  Eye,
  EyeOff
} from 'lucide-react';

interface WordPressPost {
  id: number;
  title: string;
  content: string;
  excerpt: string;
  date: string;
  modified: string;
  status: string;
  link: string;
  slug: string;
}

interface WooCommerceProduct {
  id: number;
  name: string;
  short_description: string;
  description: string;
  date_created: string;
  date_modified: string;
  status: string;
  permalink: string;
  sku: string;
  price: string;
  regular_price: string;
  categories: Array<{ id: number; name: string; slug: string }>;
  images: Array<{ src: string; alt: string }>;
}

interface SEOScore {
  overall: number;
  title: { score: number; issues: string[]; suggestions: string[] };
  meta: { score: number; issues: string[]; suggestions: string[] };
  content: { score: number; issues: string[]; suggestions: string[] };
  readability: { score: number; issues: string[]; suggestions: string[] };
  keywords: { score: number; density: number; issues: string[]; suggestions: string[] };
}

interface ContentAnalysis {
  post?: WordPressPost;
  product?: WooCommerceProduct;
  seoScore: SEOScore;
  improvements: string[];
  optimizedTitle?: string;
  optimizedMeta?: string;
  optimizedShortDescription?: string;
  optimizedLongDescription?: string;
}

interface Project {
  id: string;
  name: string;
  wordpressUrl: string | null;
}

export default function ContentOptimizerPage() {
  const { data: session } = useSession() || {};
  const [contentType, setContentType] = useState<'posts' | 'products'>('posts');
  const [projects, setProjects] = useState<Project[]>([]);
  const [selectedProjectId, setSelectedProjectId] = useState<string>('');
  const [posts, setPosts] = useState<WordPressPost[]>([]);
  const [products, setProducts] = useState<WooCommerceProduct[]>([]);
  const [analyses, setAnalyses] = useState<Map<number, ContentAnalysis>>(new Map());
  const [selectedPostId, setSelectedPostId] = useState<number | null>(null);
  const [selectedProductId, setSelectedProductId] = useState<number | null>(null);
  const [loading, setLoading] = useState(false);
  const [analyzingPostId, setAnalyzingPostId] = useState<number | null>(null);
  const [analyzingProductId, setAnalyzingProductId] = useState<number | null>(null);
  const [improvingPostId, setImprovingPostId] = useState<number | null>(null);
  const [improvingProductId, setImprovingProductId] = useState<number | null>(null);
  const [rewritingPostId, setRewritingPostId] = useState<number | null>(null);
  const [rewritingProductId, setRewritingProductId] = useState<number | null>(null);
  const [publishingPostId, setPublishingPostId] = useState<number | null>(null);
  const [publishingProductId, setPublishingProductId] = useState<number | null>(null);
  const [rewrittenContent, setRewrittenContent] = useState<string>('');
  const [focusKeyword, setFocusKeyword] = useState<string>('');
  const [updateDate, setUpdateDate] = useState<boolean>(true); // Default: update date
  const [showBeforeAfter, setShowBeforeAfter] = useState<boolean>(false);

  // Fetch projects on mount
  useEffect(() => {
    fetchProjects();
  }, [session]);

  const fetchProjects = async () => {
    try {
      const response = await fetch('/api/client/projects');
      if (!response.ok) throw new Error('Failed to fetch projects');
      const data = await response.json();
      const wpProjects = data.projects.filter((p: Project) => p.wordpressUrl);
      setProjects(wpProjects);
      if (wpProjects.length > 0 && !selectedProjectId) {
        setSelectedProjectId(wpProjects[0].id);
      }
    } catch (error) {
      console.error('Error fetching projects:', error);
      toast.error('Kon projecten niet laden');
    }
  };

  const fetchPosts = async () => {
    if (!selectedProjectId) {
      toast.error('Selecteer eerst een project');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch(`/api/content-optimizer/fetch-posts?projectId=${selectedProjectId}`);
      if (!response.ok) throw new Error('Failed to fetch posts');
      
      const data = await response.json();
      setPosts(data.posts);
      toast.success(`${data.posts.length} posts gevonden`);
    } catch (error) {
      console.error('Error fetching posts:', error);
      toast.error('Kon WordPress posts niet ophalen');
    } finally {
      setLoading(false);
    }
  };

  const fetchProducts = async () => {
    if (!selectedProjectId) {
      toast.error('Selecteer eerst een project');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch(`/api/content-optimizer/fetch-products?projectId=${selectedProjectId}`);
      if (!response.ok) throw new Error('Failed to fetch products');
      
      const data = await response.json();
      setProducts(data.products);
      toast.success(`${data.products.length} producten gevonden`);
    } catch (error) {
      console.error('Error fetching products:', error);
      toast.error('Kon WooCommerce producten niet ophalen');
    } finally {
      setLoading(false);
    }
  };

  const analyzePost = async (postId: number) => {
    setAnalyzingPostId(postId);
    try {
      const response = await fetch('/api/content-optimizer/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId, 
          postId,
          focusKeyword: focusKeyword || undefined
        }),
      });

      if (!response.ok) throw new Error('Failed to analyze post');
      
      const data = await response.json();
      setAnalyses(prev => new Map(prev).set(postId, data.analysis));
      setSelectedPostId(postId);
      toast.success('Analyse voltooid!');
    } catch (error) {
      console.error('Error analyzing post:', error);
      toast.error('Kon post niet analyseren');
    } finally {
      setAnalyzingPostId(null);
    }
  };

  const getAIImprovements = async (postId: number) => {
    setImprovingPostId(postId);
    try {
      const analysis = analyses.get(postId);
      if (!analysis) {
        toast.error('Analyseer eerst de post');
        return;
      }

      const response = await fetch('/api/content-optimizer/improve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          postId,
          currentAnalysis: analysis
        }),
      });

      if (!response.ok) throw new Error('Failed to get improvements');
      
      const data = await response.json();
      setAnalyses(prev => {
        const updated = new Map(prev);
        const current = updated.get(postId);
        if (current) {
          updated.set(postId, {
            ...current,
            optimizedTitle: data.optimizedTitle,
            optimizedMeta: data.optimizedMeta,
            improvements: [...current.improvements, ...data.contentSuggestions]
          });
        }
        return updated;
      });
      toast.success('AI verbeteringen gegenereerd!');
    } catch (error) {
      console.error('Error getting improvements:', error);
      toast.error('Kon AI verbeteringen niet genereren');
    } finally {
      setImprovingPostId(null);
    }
  };

  // üî• NEW: One-click rewrite and update to WordPress
  const rewriteAndUpdate = async (postId: number) => {
    setRewritingPostId(postId);
    setPublishingPostId(postId);
    
    try {
      toast.info('‚è≥ Tekst wordt geanalyseerd en herschreven...');
      
      // Step 1: Analyze if not done yet
      let analysis = analyses.get(postId);
      if (!analysis) {
        const analyzeResponse = await fetch('/api/content-optimizer/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            projectId: selectedProjectId, 
            postId,
            focusKeyword: focusKeyword || undefined
          }),
        });
        
        if (!analyzeResponse.ok) throw new Error('Failed to analyze post');
        const analyzeData = await analyzeResponse.json();
        analysis = analyzeData.analysis;
        setAnalyses(prev => new Map(prev).set(postId, analysis!));
      }

      toast.info('ü§ñ AI verbeteringen worden gegenereerd...');
      
      // Step 2: Get AI improvements
      const improveResponse = await fetch('/api/content-optimizer/improve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          postId,
          currentAnalysis: analysis
        }),
      });

      if (!improveResponse.ok) throw new Error('Failed to get improvements');
      const improveData = await improveResponse.json();
      
      // Update analysis with improvements
      analysis = {
        ...analysis,
        optimizedTitle: improveData.optimizedTitle,
        optimizedMeta: improveData.optimizedMeta,
        improvements: [...(analysis.improvements || []), ...(improveData.contentSuggestions || [])]
      };
      setAnalyses(prev => new Map(prev).set(postId, analysis!));

      toast.info('‚úçÔ∏è Content wordt herschreven...');
      
      // Step 3: Rewrite content
      const rewriteResponse = await fetch('/api/content-optimizer/rewrite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          postId,
          improvements: analysis.improvements
        }),
      });

      if (!rewriteResponse.ok) throw new Error('Failed to rewrite content');
      const rewriteData = await rewriteResponse.json();
      setRewrittenContent(rewriteData.rewrittenContent);

      toast.info('üì§ Wordt gepubliceerd naar WordPress...');
      
      // Step 4: Publish to WordPress (with optional date update)
      const publishResponse = await fetch('/api/content-optimizer/publish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          postId,
          updateDate: updateDate, // NEW: Send date update option
          updates: {
            content: rewriteData.rewrittenContent,
            title: improveData.optimizedTitle,
            excerpt: improveData.optimizedMeta
          }
        }),
      });

      if (!publishResponse.ok) throw new Error('Failed to publish to WordPress');
      const publishData = await publishResponse.json();
      
      // Show before/after comparison
      setShowBeforeAfter(true);
      
      const dateMsg = updateDate 
        ? `Publicatiedatum is bijgewerkt naar ${new Date().toLocaleDateString('nl-NL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`
        : '';
      
      toast.success(`‚úÖ Content succesvol bijgewerkt in WordPress!`, {
        description: dateMsg || 'De nieuwe versie is nu live op je website.',
        duration: 5000
      });
      
      // Refresh posts to show updated version
      await fetchPosts();
      
    } catch (error) {
      console.error('Error in rewrite and update:', error);
      toast.error('‚ùå Er ging iets mis tijdens het bijwerken', {
        description: error instanceof Error ? error.message : 'Probeer het opnieuw'
      });
    } finally {
      setRewritingPostId(null);
      setPublishingPostId(null);
    }
  };

  const rewriteContent = async (postId: number) => {
    setRewritingPostId(postId);
    try {
      // Check if analysis exists
      const analysis = analyses.get(postId);
      if (!analysis) {
        toast.error('Analyseer eerst de post voordat je kunt herschrijven');
        setRewritingPostId(null);
        return;
      }

      // Check if improvements were generated
      if (!analysis.optimizedTitle || !analysis.improvements || analysis.improvements.length === 0) {
        toast.error('Genereer eerst AI verbeteringen voordat je kunt herschrijven', {
          description: 'Klik op "AI Verbeteringen Genereren" in het Verbeteren tab'
        });
        setRewritingPostId(null);
        return;
      }

      toast.info('ü§ñ AI begint met herschrijven...');

      const response = await fetch('/api/content-optimizer/rewrite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          postId,
          improvements: analysis.improvements
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || 'Failed to rewrite content');
      }
      
      const data = await response.json();
      setRewrittenContent(data.rewrittenContent);
      toast.success('‚úÖ Content succesvol herschreven met AI!');
    } catch (error) {
      console.error('Error rewriting content:', error);
      toast.error('‚ùå Kon content niet herschrijven', {
        description: error instanceof Error ? error.message : 'Probeer het opnieuw'
      });
    } finally {
      setRewritingPostId(null);
    }
  };

  const publishImprovedContent = async (postId: number) => {
    setPublishingPostId(postId);
    try {
      const analysis = analyses.get(postId);
      if (!analysis) {
        toast.error('Analyseer eerst de post');
        return;
      }

      const response = await fetch('/api/content-optimizer/publish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          postId,
          updateDate: updateDate, // Send date update option
          updates: {
            title: analysis.optimizedTitle,
            content: rewrittenContent || undefined,
            meta_description: analysis.optimizedMeta,
          }
        }),
      });

      if (!response.ok) throw new Error('Failed to publish');
      
      const dateMsg = updateDate 
        ? ` Datum bijgewerkt naar ${new Date().toLocaleDateString('nl-NL')}`
        : '';
      
      toast.success(`‚úÖ Content gepubliceerd naar WordPress!${dateMsg}`);
      // Refresh posts
      fetchPosts();
    } catch (error) {
      console.error('Error publishing:', error);
      toast.error('Kon content niet publiceren');
    } finally {
      setPublishingPostId(null);
    }
  };

  // Product analysis and rewrite functions
  const analyzeProduct = async (productId: number) => {
    setAnalyzingProductId(productId);
    try {
      const response = await fetch('/api/content-optimizer/analyze-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId, 
          productId
        }),
      });

      if (!response.ok) throw new Error('Failed to analyze product');
      
      const data = await response.json();
      setAnalyses(prev => new Map(prev).set(productId, data.analysis));
      setSelectedProductId(productId);
      toast.success('Product analyse voltooid!');
    } catch (error) {
      console.error('Error analyzing product:', error);
      toast.error('Kon product niet analyseren');
    } finally {
      setAnalyzingProductId(null);
    }
  };

  const rewriteAndUpdateProduct = async (productId: number) => {
    setRewritingProductId(productId);
    setPublishingProductId(productId);
    
    try {
      toast.info('‚è≥ Product wordt geanalyseerd...');
      
      // Step 1: Analyze if not done yet
      let analysis = analyses.get(productId);
      if (!analysis) {
        const analyzeResponse = await fetch('/api/content-optimizer/analyze-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            projectId: selectedProjectId, 
            productId
          }),
        });
        
        if (!analyzeResponse.ok) throw new Error('Failed to analyze product');
        const analyzeData = await analyzeResponse.json();
        analysis = analyzeData.analysis;
        setAnalyses(prev => new Map(prev).set(productId, analysis!));
      }

      toast.info('‚úçÔ∏è Omschrijvingen worden herschreven...');
      
      // Step 2: Rewrite product descriptions
      const rewriteResponse = await fetch('/api/content-optimizer/rewrite-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          productId,
          improvements: analysis.improvements
        }),
      });

      if (!rewriteResponse.ok) throw new Error('Failed to rewrite product');
      const rewriteData = await rewriteResponse.json();

      toast.info('üì§ Wordt gepubliceerd naar WordPress...');
      
      // Step 3: Publish to WordPress
      const publishResponse = await fetch('/api/content-optimizer/publish-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          projectId: selectedProjectId,
          productId,
          updates: {
            name: rewriteData.optimizedTitle,
            shortDescription: rewriteData.shortDescription,
            longDescription: rewriteData.longDescription
          }
        }),
      });

      if (!publishResponse.ok) throw new Error('Failed to publish product');
      
      toast.success(`‚úÖ Product succesvol bijgewerkt in WordPress!`, {
        description: 'De nieuwe omschrijvingen zijn nu live.',
        duration: 5000
      });
      
      // Refresh products
      await fetchProducts();
      
    } catch (error) {
      console.error('Error in rewrite and update product:', error);
      toast.error('‚ùå Er ging iets mis tijdens het bijwerken', {
        description: error instanceof Error ? error.message : 'Probeer het opnieuw'
      });
    } finally {
      setRewritingProductId(null);
      setPublishingProductId(null);
    }
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-500';
    if (score >= 60) return 'text-yellow-500';
    return 'text-red-500';
  };

  const getScoreBadge = (score: number) => {
    if (score >= 80) return 'bg-green-500/20 text-green-500 border-green-500/30';
    if (score >= 60) return 'bg-yellow-500/20 text-yellow-500 border-yellow-500/30';
    return 'bg-red-500/20 text-red-500 border-red-500/30';
  };

  const selectedPost = selectedPostId ? posts.find(p => p.id === selectedPostId) : null;
  const selectedProduct = selectedProductId ? products.find(p => p.id === selectedProductId) : null;
  const selectedAnalysis = contentType === 'posts' && selectedPostId 
    ? analyses.get(selectedPostId) 
    : contentType === 'products' && selectedProductId 
    ? analyses.get(selectedProductId) 
    : null;

  return (
    <div className="min-h-screen bg-[#0A0A0A] text-white p-4 sm:p-6 md:p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6 sm:mb-8">
          <h1 className="text-2xl sm:text-3xl font-bold mb-2 flex items-center gap-2">
            <Search className="w-6 h-6 sm:w-8 sm:h-8 text-blue-500" />
            Content Optimizer
          </h1>
          <p className="text-sm sm:text-base text-gray-400">Analyseer en verbeter je bestaande WordPress content met AI</p>
        </div>

        {/* Project & Content Type Selector */}
        <Card className="bg-[#111111] border-gray-800 mb-6">
          <CardHeader>
            <CardTitle className="text-white">Selecteer Project & Content Type</CardTitle>
            <CardDescription>Kies het project en of je posts of producten wilt optimaliseren</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {/* Project Selector */}
              <div className="flex gap-4">
                <Select value={selectedProjectId} onValueChange={setSelectedProjectId}>
                  <SelectTrigger className="flex-1 bg-[#1a1a1a] border-gray-700 text-white">
                    <SelectValue placeholder="Selecteer een project met WordPress" />
                  </SelectTrigger>
                  <SelectContent className="bg-[#1a1a1a] border-gray-700">
                    {projects.map((project) => (
                      <SelectItem key={project.id} value={project.id} className="text-white hover:bg-[#252525]">
                        {project.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Content Type Tabs & Fetch Button */}
              <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:justify-between">
                <Tabs value={contentType} onValueChange={(value) => setContentType(value as 'posts' | 'products')} className="w-full sm:w-auto">
                  <TabsList className="bg-[#1a1a1a] w-full sm:w-auto">
                    <TabsTrigger value="posts" className="data-[state=active]:bg-blue-600 flex-1 sm:flex-none">
                      <FileText className="w-4 h-4 mr-2" />
                      <span className="text-sm sm:text-base">Berichten</span>
                    </TabsTrigger>
                    <TabsTrigger value="products" className="data-[state=active]:bg-green-600 flex-1 sm:flex-none">
                      <Search className="w-4 h-4 mr-2" />
                      <span className="text-sm sm:text-base">Producten</span>
                    </TabsTrigger>
                  </TabsList>
                </Tabs>

                <Button
                  onClick={contentType === 'posts' ? fetchPosts : fetchProducts}
                  disabled={!selectedProjectId || loading}
                  className={`w-full sm:w-auto ${contentType === 'posts' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}
                >
                  {loading ? (
                    <>
                      <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                      <span className="text-sm sm:text-base">Laden...</span>
                    </>
                  ) : (
                    <>
                      {contentType === 'posts' ? (
                        <>
                          <FileText className="w-4 h-4 mr-2" />
                          <span className="text-sm sm:text-base">Posts Ophalen</span>
                        </>
                      ) : (
                        <>
                          <Search className="w-4 h-4 mr-2" />
                          <span className="text-sm sm:text-base">Producten Ophalen</span>
                        </>
                      )}
                    </>
                  )}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Content Grid */}
        {((contentType === 'posts' && posts.length > 0) || (contentType === 'products' && products.length > 0)) && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Content List */}
            <Card className="bg-[#111111] border-gray-800">
              <CardHeader>
                <CardTitle className="text-white">
                  {contentType === 'posts' ? `WordPress Posts (${posts.length})` : `WooCommerce Producten (${products.length})`}
                </CardTitle>
                <CardDescription>
                  {contentType === 'posts' ? 'Klik op een post om te analyseren' : 'Klik op een product om te analyseren'}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <ScrollArea className="h-[600px] pr-4">
                  <div className="space-y-4">
                    {contentType === 'posts' ? (
                      // Posts List
                      posts.map((post) => {
                        const analysis = analyses.get(post.id);
                        const isAnalyzing = analyzingPostId === post.id;
                        const isSelected = selectedPostId === post.id;

                        return (
                          <div
                            key={post.id}
                            className={`p-4 rounded-lg border cursor-pointer transition-all ${
                              isSelected
                                ? 'bg-blue-500/10 border-blue-500/50'
                                : 'bg-[#1a1a1a] border-gray-700 hover:border-gray-600'
                            }`}
                            onClick={() => setSelectedPostId(post.id)}
                          >
                            <div className="flex items-start justify-between mb-2">
                              <h3 className="font-semibold text-white flex-1 line-clamp-2">
                                {post.title}
                              </h3>
                              {analysis && (
                                <Badge className={`ml-2 ${getScoreBadge(analysis.seoScore.overall)}`}>
                                  {analysis.seoScore.overall}/100
                                </Badge>
                              )}
                            </div>
                            
                            <p className="text-sm text-gray-400 mb-3 line-clamp-2">
                              {post.excerpt || 'Geen excerpt beschikbaar'}
                            </p>

                            <div className="flex items-center justify-between">
                              <span className="text-xs text-gray-500">
                                {new Date(post.date).toLocaleDateString('nl-NL')}
                              </span>
                              
                              {!analysis ? (
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    analyzePost(post.id);
                                  }}
                                  disabled={isAnalyzing}
                                  className="border-gray-700 hover:bg-[#252525]"
                                >
                                  {isAnalyzing ? (
                                    <>
                                      <RefreshCw className="w-3 h-3 mr-1 animate-spin" />
                                      Analyseren...
                                    </>
                                  ) : (
                                    <>
                                      <Search className="w-3 h-3 mr-1" />
                                      Analyseer
                                    </>
                                  )}
                                </Button>
                              ) : (
                                <div className="flex items-center gap-2">
                                  <CheckCircle2 className="w-4 h-4 text-green-500" />
                                  <span className="text-xs text-gray-400">Geanalyseerd</span>
                                </div>
                              )}
                            </div>

                            {analysis && (
                              <>
                                <div className="mt-3 grid grid-cols-5 gap-2">
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.title.score)}`}>
                                      {analysis.seoScore.title.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Titel</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.meta.score)}`}>
                                      {analysis.seoScore.meta.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Meta</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.content.score)}`}>
                                      {analysis.seoScore.content.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Content</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.readability.score)}`}>
                                      {analysis.seoScore.readability.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Lees</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.keywords.score)}`}>
                                      {analysis.seoScore.keywords.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Keys</div>
                                  </div>
                                </div>
                                
                                <Button
                                  size="sm"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    rewriteAndUpdate(post.id);
                                  }}
                                  disabled={rewritingPostId === post.id || publishingPostId === post.id}
                                  className="w-full mt-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
                                >
                                  {rewritingPostId === post.id || publishingPostId === post.id ? (
                                    <>
                                      <RefreshCw className="w-3 h-3 mr-2 animate-spin" />
                                      Bezig met updaten...
                                    </>
                                  ) : (
                                    <>
                                      <Zap className="w-3 h-3 mr-2" />
                                      Herschrijven & Updaten
                                    </>
                                  )}
                                </Button>
                              </>
                            )}
                          </div>
                        );
                      })
                    ) : (
                      // Products List
                      products.map((product) => {
                        const analysis = analyses.get(product.id);
                        const isAnalyzing = analyzingProductId === product.id;
                        const isSelected = selectedProductId === product.id;

                        return (
                          <div
                            key={product.id}
                            className={`p-4 rounded-lg border cursor-pointer transition-all ${
                              isSelected
                                ? 'bg-green-500/10 border-green-500/50'
                                : 'bg-[#1a1a1a] border-gray-700 hover:border-gray-600'
                            }`}
                            onClick={() => setSelectedProductId(product.id)}
                          >
                            <div className="flex items-start gap-3 mb-2">
                              {product.images?.[0] && (
                                <img 
                                  src={product.images[0].src} 
                                  alt={product.images[0].alt || product.name}
                                  className="w-16 h-16 object-cover rounded"
                                />
                              )}
                              <div className="flex-1">
                                <div className="flex items-start justify-between">
                                  <h3 className="font-semibold text-white line-clamp-2">
                                    {product.name}
                                  </h3>
                                  {analysis && (
                                    <Badge className={`ml-2 ${getScoreBadge(analysis.seoScore.overall)}`}>
                                      {analysis.seoScore.overall}/100
                                    </Badge>
                                  )}
                                </div>
                                {product.price && (
                                  <p className="text-sm text-green-400 font-semibold mt-1">
                                    ‚Ç¨{product.price}
                                  </p>
                                )}
                              </div>
                            </div>

                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-gray-500">
                                  SKU: {product.sku || 'Geen'}
                                </span>
                                {product.categories?.[0] && (
                                  <Badge variant="outline" className="text-xs">
                                    {product.categories[0].name}
                                  </Badge>
                                )}
                              </div>
                              
                              {!analysis ? (
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    analyzeProduct(product.id);
                                  }}
                                  disabled={isAnalyzing}
                                  className="border-gray-700 hover:bg-[#252525]"
                                >
                                  {isAnalyzing ? (
                                    <>
                                      <RefreshCw className="w-3 h-3 mr-1 animate-spin" />
                                      Analyseren...
                                    </>
                                  ) : (
                                    <>
                                      <Search className="w-3 h-3 mr-1" />
                                      Analyseer
                                    </>
                                  )}
                                </Button>
                              ) : (
                                <div className="flex items-center gap-2">
                                  <CheckCircle2 className="w-4 h-4 text-green-500" />
                                  <span className="text-xs text-gray-400">Geanalyseerd</span>
                                </div>
                              )}
                            </div>

                            {analysis && (
                              <>
                                <div className="mt-3 grid grid-cols-5 gap-2">
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.title.score)}`}>
                                      {analysis.seoScore.title.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Naam</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.meta.score)}`}>
                                      {analysis.seoScore.meta.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Kort</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.content.score)}`}>
                                      {analysis.seoScore.content.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Lang</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.readability.score)}`}>
                                      {analysis.seoScore.readability.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Lees</div>
                                  </div>
                                  <div className="text-center">
                                    <div className={`text-xs font-semibold ${getScoreColor(analysis.seoScore.keywords.score)}`}>
                                      {analysis.seoScore.keywords.score}
                                    </div>
                                    <div className="text-xs text-gray-500">Keys</div>
                                  </div>
                                </div>
                                
                                <Button
                                  size="sm"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    rewriteAndUpdateProduct(product.id);
                                  }}
                                  disabled={rewritingProductId === product.id || publishingProductId === product.id}
                                  className="w-full mt-3 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700"
                                >
                                  {rewritingProductId === product.id || publishingProductId === product.id ? (
                                    <>
                                      <RefreshCw className="w-3 h-3 mr-2 animate-spin" />
                                      Bezig met updaten...
                                    </>
                                  ) : (
                                    <>
                                      <Zap className="w-3 h-3 mr-2" />
                                      Herschrijven & Updaten
                                    </>
                                  )}
                                </Button>
                              </>
                            )}
                          </div>
                        );
                      })
                    )}
                  </div>
                </ScrollArea>
              </CardContent>
            </Card>

            {/* Analysis Details */}
            <Card className="bg-[#111111] border-gray-800">
              <CardHeader>
                <CardTitle className="text-white">Analyse & Verbeteringen</CardTitle>
                <CardDescription>
                  {contentType === 'posts' && selectedPost 
                    ? selectedPost.title 
                    : contentType === 'products' && selectedProduct
                    ? selectedProduct.name
                    : `Selecteer een ${contentType === 'posts' ? 'post' : 'product'} om details te zien`}
                </CardDescription>
              </CardHeader>
              <CardContent>
                {((contentType === 'posts' && selectedPost && selectedAnalysis) || (contentType === 'products' && selectedProduct && selectedAnalysis)) ? (
                  <ScrollArea className="h-[600px] pr-4">
                    {/* üìù HUIDIGE CONTENT PREVIEW */}
                    <div className="mb-4 p-4 bg-[#1a1a1a] rounded-lg border border-gray-800">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-semibold text-white flex items-center gap-2">
                          <Eye className="w-4 h-4 text-blue-500" />
                          Huidige Content op de Pagina
                        </h4>
                        <Badge variant="outline" className="text-xs">
                          <Calendar className="w-3 h-3 mr-1" />
                          {contentType === 'posts' && selectedPost 
                            ? new Date(selectedPost.date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })
                            : contentType === 'products' && selectedProduct
                            ? new Date(selectedProduct.date_created).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })
                            : ''
                          }
                        </Badge>
                      </div>
                      <div className="space-y-2 text-sm">
                        <div>
                          <span className="text-gray-400">Titel: </span>
                          <span className="text-white">{contentType === 'posts' && selectedPost ? selectedPost.title : contentType === 'products' && selectedProduct ? selectedProduct.name : ''}</span>
                        </div>
                        <div>
                          <span className="text-gray-400">Excerpt: </span>
                          <span className="text-white line-clamp-2">{contentType === 'posts' && selectedPost ? selectedPost.excerpt : contentType === 'products' && selectedProduct ? selectedProduct.short_description?.replace(/<[^>]*>/g, '') : ''}</span>
                        </div>
                        <div>
                          <span className="text-gray-400">Woorden: </span>
                          <span className="text-white">
                            {contentType === 'posts' && selectedPost 
                              ? selectedPost.content.split(/\s+/).length 
                              : contentType === 'products' && selectedProduct 
                              ? selectedProduct.description.split(/\s+/).length 
                              : 0
                            } woorden
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* ‚öôÔ∏è UPDATE OPTIES */}
                    <div className="mb-4 p-4 bg-[#1a1a1a] rounded-lg border border-gray-800">
                      <h4 className="font-semibold text-white mb-3">Update Opties</h4>
                      <div className="flex items-center justify-between">
                        <div className="space-y-0.5">
                          <Label htmlFor="update-date" className="text-white cursor-pointer">
                            Publicatiedatum bijwerken naar vandaag
                          </Label>
                          <p className="text-xs text-gray-400">
                            De post krijgt een nieuwe datum: {new Date().toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                          </p>
                        </div>
                        <Switch
                          id="update-date"
                          checked={updateDate}
                          onCheckedChange={setUpdateDate}
                        />
                      </div>
                    </div>

                    {/* üî• ONE-CLICK REWRITE & UPDATE BUTTON */}
                    <Button
                      onClick={() => contentType === 'posts' && selectedPost 
                        ? rewriteAndUpdate(selectedPost.id) 
                        : contentType === 'products' && selectedProduct 
                        ? rewriteAndUpdateProduct(selectedProduct.id) 
                        : null}
                      disabled={
                        (contentType === 'posts' && (rewritingPostId === selectedPost?.id || publishingPostId === selectedPost?.id)) ||
                        (contentType === 'products' && (rewritingProductId === selectedProduct?.id || publishingProductId === selectedProduct?.id))
                      }
                      className="w-full mb-4 bg-gradient-to-r from-purple-600 via-blue-600 to-green-600 hover:from-purple-700 hover:via-blue-700 hover:to-green-700 text-white font-semibold py-6 text-lg shadow-lg"
                    >
                      {((contentType === 'posts' && (rewritingPostId === selectedPost?.id || publishingPostId === selectedPost?.id)) ||
                        (contentType === 'products' && (rewritingProductId === selectedProduct?.id || publishingProductId === selectedProduct?.id))) ? (
                        <>
                          <RefreshCw className="w-5 h-5 mr-2 animate-spin" />
                          Bezig met herschrijven & updaten...
                        </>
                      ) : (
                        <>
                          <Zap className="w-5 h-5 mr-2" />
                          ‚ö° Herschrijven & Direct Updaten in WordPress
                        </>
                      )}
                    </Button>

                    <Tabs defaultValue="analysis" className="w-full">
                      <TabsList className="grid w-full grid-cols-3 bg-[#1a1a1a]">
                        <TabsTrigger value="analysis">Analyse</TabsTrigger>
                        <TabsTrigger value="improvements">Verbeteringen</TabsTrigger>
                        <TabsTrigger value="rewrite">Herschrijven</TabsTrigger>
                      </TabsList>

                      <TabsContent value="analysis" className="space-y-4 mt-4">
                        {/* Overall Score */}
                        <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-sm text-gray-400">Overall SEO Score</span>
                            <span className={`text-2xl font-bold ${getScoreColor(selectedAnalysis.seoScore.overall)}`}>
                              {selectedAnalysis.seoScore.overall}/100
                            </span>
                          </div>
                          <Progress value={selectedAnalysis.seoScore.overall} className="h-2" />
                        </div>

                        {/* Detailed Scores */}
                        {Object.entries({
                          Titel: selectedAnalysis.seoScore.title,
                          'Meta Beschrijving': selectedAnalysis.seoScore.meta,
                          Content: selectedAnalysis.seoScore.content,
                          Leesbaarheid: selectedAnalysis.seoScore.readability,
                          Keywords: selectedAnalysis.seoScore.keywords,
                        }).map(([category, data]) => (
                          <div key={category} className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="font-semibold text-white">{category}</h4>
                              <span className={`font-bold ${getScoreColor(data.score)}`}>
                                {data.score}/100
                              </span>
                            </div>
                            
                            {data.issues.length > 0 && (
                              <div className="mt-2 space-y-1">
                                <p className="text-xs text-gray-500 mb-1">Problemen:</p>
                                {data.issues.map((issue, idx) => (
                                  <div key={idx} className="flex items-start gap-2">
                                    <AlertCircle className="w-3 h-3 text-red-500 mt-0.5 flex-shrink-0" />
                                    <span className="text-sm text-gray-300">{issue}</span>
                                  </div>
                                ))}
                              </div>
                            )}

                            {data.suggestions.length > 0 && (
                              <div className="mt-2 space-y-1">
                                <p className="text-xs text-gray-500 mb-1">Suggesties:</p>
                                {data.suggestions.map((suggestion, idx) => (
                                  <div key={idx} className="flex items-start gap-2">
                                    <TrendingUp className="w-3 h-3 text-blue-500 mt-0.5 flex-shrink-0" />
                                    <span className="text-sm text-gray-300">{suggestion}</span>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}

                        <Button
                          onClick={() => {
                            const link = contentType === 'posts' && selectedPost 
                              ? selectedPost.link 
                              : contentType === 'products' && selectedProduct 
                              ? selectedProduct.permalink 
                              : null;
                            if (link) window.open(link, '_blank');
                          }}
                          variant="outline"
                          className="w-full border-gray-700 hover:bg-[#252525]"
                        >
                          <ExternalLink className="w-4 h-4 mr-2" />
                          Bekijk originele {contentType === 'posts' ? 'post' : 'product'}
                        </Button>
                      </TabsContent>

                      <TabsContent value="improvements" className="space-y-4 mt-4">
                        {!selectedAnalysis.optimizedTitle ? (
                          <div className="text-center py-8">
                            <Sparkles className="w-12 h-12 mx-auto mb-4 text-purple-500" />
                            <p className="text-gray-400 mb-4">
                              Laat AI verbeteringen genereren voor deze post
                            </p>
                            <Button
                              onClick={() => getAIImprovements(selectedPost.id)}
                              disabled={improvingPostId === selectedPost.id}
                              className="bg-purple-600 hover:bg-purple-700"
                            >
                              {improvingPostId === selectedPost.id ? (
                                <>
                                  <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                  AI denkt na...
                                </>
                              ) : (
                                <>
                                  <Sparkles className="w-4 h-4 mr-2" />
                                  Genereer AI Verbeteringen
                                </>
                              )}
                            </Button>
                          </div>
                        ) : (
                          <>
                            {/* Optimized Title */}
                            <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                              <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                                <Sparkles className="w-4 h-4 text-purple-500" />
                                Geoptimaliseerde Titel
                              </h4>
                              <p className="text-sm text-gray-400 mb-2">Huidig:</p>
                              <p className="text-sm text-gray-300 mb-3">{selectedPost.title}</p>
                              <p className="text-sm text-gray-400 mb-2">Nieuw:</p>
                              <p className="text-sm text-green-400 font-semibold">{selectedAnalysis.optimizedTitle}</p>
                            </div>

                            {/* Optimized Meta */}
                            <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                              <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                                <Sparkles className="w-4 h-4 text-purple-500" />
                                Geoptimaliseerde Meta Beschrijving
                              </h4>
                              <p className="text-sm text-gray-400 mb-2">Huidig:</p>
                              <p className="text-sm text-gray-300 mb-3">{selectedPost.excerpt || 'Geen meta beschrijving'}</p>
                              <p className="text-sm text-gray-400 mb-2">Nieuw:</p>
                              <p className="text-sm text-green-400 font-semibold">{selectedAnalysis.optimizedMeta}</p>
                            </div>

                            {/* Content Suggestions */}
                            <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                              <h4 className="font-semibold text-white mb-3 flex items-center gap-2">
                                <TrendingUp className="w-4 h-4 text-blue-500" />
                                Content Verbeteringen
                              </h4>
                              <div className="space-y-2">
                                {selectedAnalysis.improvements.map((improvement, idx) => (
                                  <div key={idx} className="flex items-start gap-2">
                                    <span className="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded mt-0.5">
                                      {idx + 1}
                                    </span>
                                    <span className="text-sm text-gray-300 flex-1">{improvement}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </>
                        )}
                      </TabsContent>

                      <TabsContent value="rewrite" className="space-y-4 mt-4">
                        {!rewrittenContent ? (
                          <div className="text-center py-8">
                            <Edit3 className="w-12 h-12 mx-auto mb-4 text-green-500" />
                            <p className="text-gray-400 mb-4">
                              Laat AI de volledige content herschrijven met alle verbeteringen
                            </p>
                            
                            {/* ‚ö†Ô∏è Waarschuwing als verbeteringen nog niet zijn gegenereerd */}
                            {!selectedAnalysis.optimizedTitle && (
                              <div className="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                <AlertCircle className="w-5 h-5 mx-auto mb-2 text-yellow-500" />
                                <p className="text-sm text-yellow-500 mb-2">
                                  Je moet eerst AI verbeteringen genereren
                                </p>
                                <p className="text-xs text-gray-400">
                                  Ga naar het "Verbeteren" tab en klik op "AI Verbeteringen Genereren"
                                </p>
                              </div>
                            )}
                            
                            <Button
                              onClick={() => rewriteContent(selectedPost.id)}
                              disabled={rewritingPostId === selectedPost.id}
                              className="bg-green-600 hover:bg-green-700 disabled:opacity-50"
                            >
                              {rewritingPostId === selectedPost.id ? (
                                <>
                                  <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                  AI schrijft...
                                </>
                              ) : (
                                <>
                                  <Zap className="w-4 h-4 mr-2" />
                                  Herschrijf Content met AI
                                </>
                              )}
                            </Button>
                          </div>
                        ) : (
                          <>
                            <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                              <h4 className="font-semibold text-white mb-3">Herschreven Content</h4>
                              <div 
                                className="prose prose-invert prose-sm max-w-none"
                                dangerouslySetInnerHTML={{ __html: rewrittenContent }}
                              />
                            </div>

                            <Button
                              onClick={() => publishImprovedContent(selectedPost.id)}
                              disabled={publishingPostId === selectedPost.id}
                              className="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700"
                            >
                              {publishingPostId === selectedPost.id ? (
                                <>
                                  <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                  Publiceren...
                                </>
                              ) : (
                                <>
                                  <Send className="w-4 h-4 mr-2" />
                                  Publiceer naar WordPress
                                </>
                              )}
                            </Button>
                          </>
                        )}
                      </TabsContent>
                    </Tabs>
                  </ScrollArea>
                ) : (
                  <div className="h-[600px] flex items-center justify-center text-gray-500">
                    <div className="text-center">
                      <FileText className="w-16 h-16 mx-auto mb-4 text-gray-700" />
                      <p>Selecteer een {contentType === 'posts' ? 'post' : 'product'} om de analyse te bekijken</p>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        )}

        {/* Empty State */}
        {((contentType === 'posts' && posts.length === 0) || (contentType === 'products' && products.length === 0)) && !loading && (
          <Card className="bg-[#111111] border-gray-800">
            <CardContent className="py-12">
              <div className="text-center">
                <FileText className="w-16 h-16 mx-auto mb-4 text-gray-700" />
                <h3 className="text-xl font-semibold text-white mb-2">
                  Geen {contentType === 'posts' ? 'posts' : 'producten'} gevonden
                </h3>
                <p className="text-gray-400 mb-6">
                  Selecteer een project en klik op "{contentType === 'posts' ? 'Posts' : 'Producten'} Ophalen" om te beginnen
                </p>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}